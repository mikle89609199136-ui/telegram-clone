<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zhuravlev Telegram v10.1</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            --bg-color: #0e1621;
            --surface-color: #17212b;
            --border-color: #2b3b4a;
            --text-primary: #fff;
            --text-secondary: #8e9eae;
            --accent-color: #2ea6ff;
            --message-own: #2ea6ff;
            --message-other: #17212b;
            --message-other-text: #fff;
            --chat-bg: #0e1621;
            background-color: var(--bg-color);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background 0.3s, color 0.3s;
        }

        body.light-theme {
            --bg-color: #f5f5f5;
            --surface-color: #ffffff;
            --border-color: #e0e0e0;
            --text-primary: #000000;
            --text-secondary: #5e6f7e;
            --message-other: #e4e6eb;
            --message-other-text: #000;
            --chat-bg: #f5f5f5;
        }

        body.blue-theme {
            --bg-color: #1a2b3c;
            --surface-color: #1e3a5f;
            --border-color: #2c4a6e;
            --accent-color: #64b5f6;
            --message-own: #64b5f6;
            --message-other: #1e3a5f;
            --chat-bg: #1a2b3c;
        }

        body.green-theme {
            --bg-color: #1a2e1a;
            --surface-color: #1f4a2c;
            --border-color: #2a5e3a;
            --accent-color: #81c784;
            --message-own: #81c784;
            --message-other: #1f4a2c;
            --chat-bg: #1a2e1a;
        }

        body.purple-theme {
            --bg-color: #1e1a2e;
            --surface-color: #312a4a;
            --border-color: #453c63;
            --accent-color: #b39ddb;
            --message-own: #b39ddb;
            --message-other: #312a4a;
            --chat-bg: #1e1a2e;
        }

        body.wallpaper-default { --chat-bg: var(--bg-color); }
        body.wallpaper-light { --chat-bg: #e0e0e0; }
        body.wallpaper-dark { --chat-bg: #0a0a0a; }
        body.wallpaper-gradient { --chat-bg: linear-gradient(145deg, #1e3a5f, #0e1621); }
        body.wallpaper-pattern { --chat-bg: repeating-linear-gradient(45deg, #2b3b4a 0px, #2b3b4a 2px, #17212b 2px, #17212b 8px); }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }

        #app { height: 100%; display: flex; flex-direction: column; position: relative; }
        .screen { display: none; height: 100%; flex-direction: column; background: var(--bg-color); animation: slideIn 0.3s ease; }
        .screen.active { display: flex; }

        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pop { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        /* –ü–ö –≤–µ—Ä—Å–∏—è */
        body.pc-mode #main-screen.active {
            display: grid;
            grid-template-columns: 350px 1fr;
            grid-template-rows: auto 1fr auto;
            grid-template-areas:
                "top-bar top-bar"
                "content-area chat-panel"
                "bottom-nav chat-panel";
        }
        body.pc-mode #main-screen.active #top-bar { grid-area: top-bar; }
        body.pc-mode #main-screen.active #content-area { grid-area: content-area; overflow-y: auto; }
        body.pc-mode #main-screen.active .bottom-nav { grid-area: bottom-nav; }
        body.pc-mode #main-screen.active #chat-panel {
            grid-area: chat-panel;
            background: var(--surface-color);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        /* –ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è */
        body.mobile-mode .bottom-nav { display: flex; }
        body.mobile-mode #chat-panel { display: none; }
        body.mobile-mode #main-screen.active { display: flex; flex-direction: column; }
        body.mobile-mode .folders-row { padding: 4px 8px; }
        body.mobile-mode .chat-item { padding: 8px 12px; }
        body.mobile-mode .chat-avatar { width: 48px; height: 48px; font-size: 20px; }
        body.mobile-mode .top-bar { padding: 8px 12px; }
        body.mobile-mode .bottom-nav { padding: 4px 0; }

        .top-bar {
            background: var(--surface-color);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }
        .top-bar h1 { flex: 1; font-size: 20px; font-weight: 600; }
        .top-bar .edit-btn, .top-bar .create-btn, .top-bar .back-btn {
            background: none; border: none; color: var(--accent-color);
            font-size: 16px; margin-right: 16px; cursor: pointer;
        }
        .top-bar .back-btn { font-size: 24px; margin-right: 12px; }
        .top-bar .create-btn { font-size: 24px; }

        .search-box { padding: 8px 16px; background: var(--surface-color); }
        .search-box input {
            width: 100%; padding: 12px 18px; background: var(--border-color);
            border: none; border-radius: 24px; color: var(--text-primary); outline: none;
        }
        .search-box input::placeholder { color: var(--text-secondary); }

        .bottom-nav {
            display: flex; background: var(--surface-color);
            border-top: 1px solid var(--border-color); padding: 8px 0;
        }
        .nav-item {
            flex: 1; text-align: center; color: var(--text-secondary);
            font-size: 12px; padding: 8px; cursor: pointer;
        }
        .nav-item.active { color: var(--accent-color); }
        .nav-item i { display: block; font-size: 24px; margin-bottom: 4px; }

        .folders-row {
            display: flex; gap: 8px; padding: 8px 16px;
            background: var(--surface-color); border-bottom: 1px solid var(--border-color);
            overflow-x: auto; white-space: nowrap;
        }
        .folder-chip {
            padding: 6px 12px; background: var(--bg-color);
            border: 1px solid var(--border-color); border-radius: 20px;
            cursor: pointer; transition: 0.2s;
        }
        .folder-chip.active { background: var(--accent-color); color: #fff; border-color: var(--accent-color); }

        .chats-list, .contacts-list, .participant-list {
            flex: 1; overflow-y: auto; padding: 0;
        }
        .chat-item, .contact-item, .participant-item {
            display: flex; align-items: center; padding: 12px 16px;
            background: var(--bg-color); border-bottom: 1px solid var(--border-color);
            cursor: pointer; transition: background 0.2s; position: relative;
            animation: fadeIn 0.2s;
        }
        .chat-item:hover, .contact-item:hover, .participant-item:hover { background: var(--surface-color); }
        .chat-item.pinned { background: var(--surface-color); border-left: 4px solid var(--accent-color); }

        .chat-avatar {
            width: 54px; height: 54px; border-radius: 50%;
            background: var(--accent-color); display: flex; align-items: center;
            justify-content: center; font-size: 24px; color: #fff;
            margin-right: 12px; flex-shrink: 0; object-fit: cover;
            position: relative;
        }
        .chat-avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .online-indicator {
            position: absolute; bottom: 2px; right: 2px;
            width: 14px; height: 14px; background: #4caf50;
            border: 2px solid var(--surface-color); border-radius: 50%;
        }

        .chat-info { flex: 1; min-width: 0; }
        .chat-name { font-weight: 600; margin-bottom: 4px; display: flex; align-items: center; gap: 4px; }
        .chat-username { color: var(--text-secondary); font-size: 14px; }
        .chat-last-msg { color: var(--text-secondary); font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-meta { text-align: right; font-size: 12px; color: var(--text-secondary); }
        .chat-time { margin-bottom: 4px; }
        .chat-unread { background: var(--accent-color); color: #fff; border-radius: 12px; padding: 2px 6px; font-size: 10px; }
        .chat-pin { color: var(--accent-color); font-size: 12px; margin-right: 4px; }
        .folder-tag {
            display: inline-block; width: 8px; height: 8px; border-radius: 50%;
            margin-right: 2px;
        }

        .edit-bar {
            background: var(--surface-color); padding: 12px 16px;
            display: flex; align-items: center; border-bottom: 1px solid var(--border-color);
        }
        .edit-counter { flex: 1; font-weight: 600; }
        .edit-actions button {
            background: none; border: none; color: var(--accent-color);
            font-size: 16px; margin-left: 16px; cursor: pointer;
        }

        .chat-window { display: flex; flex-direction: column; height: 100%; background: var(--chat-bg); }
        .chat-header {
            background: var(--surface-color); padding: 12px 16px;
            display: flex; align-items: center; border-bottom: 1px solid var(--border-color);
            cursor: pointer; position: relative;
        }
        .back-btn { background: none; border: none; color: var(--accent-color); font-size: 24px; margin-right: 12px; cursor: pointer; }
        .chat-header-info { flex: 1; }
        .chat-header-name { font-weight: 600; }
        .chat-header-status { font-size: 12px; color: var(--text-secondary); }
        .chat-menu {
            position: absolute; top: 60px; right: 10px; background: var(--surface-color);
            border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); z-index: 1000;
            min-width: 200px; display: none; animation: pop 0.1s;
        }
        .chat-menu-item {
            padding: 12px 16px; cursor: pointer; border-bottom: 1px solid var(--border-color);
        }
        .chat-menu-item:last-child { border-bottom: none; }
        .chat-menu-item:hover { background: var(--border-color); }

        .messages-area { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; }
        .message {
            max-width: 80%; margin-bottom: 12px; display: flex; flex-direction: column;
            position: relative; animation: pop 0.15s ease-out;
        }
        .message.own { align-self: flex-end; }
        .message-header {
            display: flex; align-items: center; gap: 6px; margin-bottom: 2px;
            font-size: 13px; cursor: pointer;
        }
        .message-sender-avatar {
            width: 20px; height: 20px; border-radius: 50%;
            background: var(--accent-color); display: flex; align-items: center;
            justify-content: center; font-size: 10px; color: #fff;
        }
        .message-sender-name { color: var(--accent-color); font-weight: 500; }
        .message-bubble {
            background: var(--message-other); border-radius: 18px;
            padding: 8px 12px; color: var(--message-other-text); word-wrap: break-word;
        }
        .message.own .message-bubble { background: var(--message-own); color: #fff; }
        .message-time { font-size: 10px; color: var(--text-secondary); margin-top: 2px; align-self: flex-end; }
        .message.own .message-time { color: var(--accent-color); }

        .message-reactions {
            display: flex; gap: 4px; margin-top: 2px; justify-content: flex-end;
        }
        .reaction {
            background: var(--surface-color); border-radius: 12px;
            padding: 2px 6px; font-size: 12px; display: flex; align-items: center; gap: 2px;
            cursor: pointer;
        }

        .file-message { display: flex; align-items: center; gap: 8px; }
        .file-icon { font-size: 24px; }
        .media-preview { max-width: 200px; max-height: 200px; border-radius: 12px; cursor: pointer; transition: transform 0.2s; }
        .media-preview:hover { transform: scale(1.02); }
        .voice-message { display: flex; align-items: center; gap: 8px; }
        .voice-circle {
            width: 40px; height: 40px; border-radius: 50%;
            background: var(--accent-color); display: flex; align-items: center;
            justify-content: center; color: #fff; cursor: pointer;
        }

        .message-context-menu {
            position: absolute; background: var(--surface-color); border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5); z-index: 1000;
            min-width: 200px; display: none; animation: pop 0.1s;
        }
        .message-context-item {
            padding: 12px 16px; cursor: pointer; border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; gap: 8px;
        }
        .message-context-item:last-child { border-bottom: none; }
        .message-context-item:hover { background: var(--border-color); }

        .reactions-scroll {
            display: flex; overflow-x: auto; gap: 8px; padding: 8px;
            background: var(--surface-color); border-radius: 12px;
        }
        .reaction-option {
            font-size: 24px; cursor: pointer; padding: 4px;
        }

        .input-area {
            background: var(--surface-color); padding: 12px 16px;
            display: flex; align-items: center; border-top: 1px solid var(--border-color);
        }
        .attach-btn { background: none; border: none; font-size: 24px; color: var(--text-secondary); margin-right: 12px; cursor: pointer; }
        .input-wrapper {
            flex: 1; background: var(--border-color); border-radius: 24px;
            padding: 8px 16px; display: flex; align-items: center;
        }
        .input-wrapper input {
            flex: 1; background: transparent; border: none; color: var(--text-primary);
            outline: none; font-size: 16px;
        }
        .input-wrapper input::placeholder { color: var(--text-secondary); }
        .emoji-btn, .voice-btn, .send-btn {
            background: none; border: none; font-size: 22px; color: var(--text-secondary);
            margin-left: 8px; cursor: pointer; transition: transform 0.1s;
        }
        .emoji-btn:hover, .voice-btn:hover, .send-btn:hover { transform: scale(1.1); }
        .send-btn { color: var(--accent-color); }

        #file-input { display: none; }

        .emoji-picker {
            position: absolute; bottom: 80px; right: 16px;
            background: var(--surface-color); border-radius: 24px; padding: 12px;
            display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px;
            z-index: 1000; box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            max-height: 300px; overflow-y: auto; animation: pop 0.2s;
        }
        .emoji-item { font-size: 24px; cursor: pointer; text-align: center; transition: transform 0.1s; }
        .emoji-item:hover { transform: scale(1.2); }

        .attach-menu {
            position: absolute; bottom: 80px; left: 16px;
            background: var(--surface-color); border-radius: 24px; padding: 12px;
            display: flex; flex-direction: column; gap: 8px;
            z-index: 1000; box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            animation: pop 0.2s;
        }
        .attach-menu-item {
            padding: 8px 16px; cursor: pointer; display: flex; align-items: center; gap: 8px;
        }
        .attach-menu-item:hover { background: var(--border-color); border-radius: 12px; }

        .poll-screen {
            padding: 16px;
        }
        .poll-screen input, .poll-screen textarea {
            width: 100%; padding: 12px; margin-bottom: 16px;
            background: var(--surface-color); border: 1px solid var(--border-color);
            border-radius: 12px; color: var(--text-primary);
        }
        .poll-screen label { display: block; margin-bottom: 8px; }

        .profile-header {
            display: flex; flex-direction: column; align-items: center;
            padding: 24px 16px; background: var(--surface-color);
            border-bottom: 1px solid var(--border-color);
        }
        .profile-avatar {
            width: 100px; height: 100px; border-radius: 50%;
            background: var(--accent-color); display: flex; align-items: center;
            justify-content: center; font-size: 40px; color: #fff;
            margin-bottom: 16px; cursor: pointer; object-fit: cover; position: relative;
        }
        .profile-avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .profile-name { font-size: 24px; font-weight: 600; }
        .profile-username { font-size: 16px; color: var(--text-secondary); margin-bottom: 8px; }
        .profile-birthday { font-size: 14px; color: var(--text-secondary); }
        .profile-section { padding: 16px; border-bottom: 1px solid var(--border-color); }
        .profile-section-title { font-weight: 600; margin-bottom: 8px; }
        .profile-media {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px;
        }
        .profile-media-item {
            background: var(--surface-color); border-radius: 8px; padding: 8px;
            text-align: center; font-size: 12px; cursor: pointer;
        }
        .profile-action {
            padding: 12px 16px; background: var(--surface-color); border-radius: 12px;
            margin-bottom: 8px; cursor: pointer; display: flex; justify-content: space-between;
        }

        .settings-list { flex: 1; overflow-y: auto; padding: 16px; }
        .settings-item {
            display: flex; align-items: center; padding: 16px;
            background: var(--surface-color); border-radius: 12px;
            margin-bottom: 8px; cursor: pointer;
        }
        .settings-icon { font-size: 24px; margin-right: 16px; }
        .settings-content { flex: 1; }
        .settings-title { font-weight: 600; }
        .settings-subtitle { font-size: 12px; color: var(--text-secondary); }
        .settings-value { color: var(--accent-color); }

        .folder-item {
            display: flex; align-items: center; padding: 12px 16px;
            background: var(--surface-color); border-radius: 12px;
            margin-bottom: 8px; cursor: pointer;
        }
        .folder-name { flex: 1; font-weight: 600; }
        .folder-count { color: var(--text-secondary); }
        .folder-color {
            width: 12px; height: 12px; border-radius: 50%; margin-right: 8px;
        }
        .folder-color.black { background: #000; }
        .folder-color.white { background: #fff; border: 1px solid #ccc; }
        .folder-color.yellow { background: #ff0; }
        .folder-color.red { background: #f00; }
        .folder-color.blue { background: #00f; }
        .folder-color.green { background: #0f0; }
        .folder-color.orange { background: #ffa500; }

        .color-picker { display: flex; gap: 8px; margin: 16px 0; }
        .color-option {
            width: 40px; height: 40px; border-radius: 50%; cursor: pointer;
            border: 2px solid transparent;
        }
        .color-option.selected { border-color: var(--accent-color); }

        .theme-option, .lang-option {
            padding: 12px 16px; background: var(--surface-color); border-radius: 12px;
            margin-bottom: 8px; cursor: pointer; text-align: center;
        }
        .theme-option.active, .lang-option.active { border: 2px solid var(--accent-color); }

        .privacy-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 16px; background: var(--surface-color); border-radius: 12px;
            margin-bottom: 8px; cursor: pointer;
        }
        .privacy-value { color: var(--accent-color); }

        .device-item {
            display: flex; align-items: center; padding: 12px 16px;
            background: var(--surface-color); border-radius: 12px;
            margin-bottom: 8px; cursor: pointer;
        }
        .device-icon { font-size: 24px; margin-right: 16px; }
        .device-info { flex: 1; }
        .device-name { font-weight: 600; }
        .device-detail { font-size: 12px; color: var(--text-secondary); }

        #auth-screen {
            background: linear-gradient(145deg, #1f2b38, #0e1621);
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .auth-card {
            background: var(--surface-color);
            border-radius: 24px;
            padding: 32px 24px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            animation: pop 0.3s;
            text-align: center;
        }
        .auth-avatar {
            font-size: 80px;
            margin-bottom: 16px;
        }
        .auth-title {
            font-size: 28px;
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: 32px;
        }
        .auth-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .auth-btn {
            padding: 16px;
            border: none;
            border-radius: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .auth-btn.register {
            background: var(--accent-color);
            color: #fff;
            font-size: 18px;
        }
        .auth-btn.login {
            background: var(--surface-color);
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
            font-size: 16px;
        }
        .auth-form {
            display: none;
            text-align: left;
        }
        .auth-form.active {
            display: block;
        }
        .auth-form h2 {
            margin-bottom: 16px;
            color: var(--text-primary);
        }
        .auth-form input {
            width: 100%;
            padding: 16px;
            margin-bottom: 16px;
            background: var(--border-color);
            border: none;
            border-radius: 14px;
            color: var(--text-primary);
            outline: none;
        }
        .auth-form button {
            width: 100%;
            padding: 16px;
            background: var(--accent-color);
            border: none;
            border-radius: 14px;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
        }
        .back-link {
            display: inline-block;
            margin-top: 16px;
            color: var(--accent-color);
            cursor: pointer;
        }

        .media-modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9); display: flex; align-items: center;
            justify-content: center; z-index: 2000; cursor: pointer;
        }
        .media-modal img, .media-modal video {
            max-width: 90%; max-height: 90%;
        }

        .next-btn {
            width: 56px; height: 56px; border-radius: 50%;
            background: var(--accent-color); border: none;
            color: #fff; font-size: 24px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            margin: 16px auto; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); display: none; align-items: center;
            justify-content: center; z-index: 3000; animation: fadeIn 0.2s;
        }
        .modal {
            background: var(--surface-color); border-radius: 24px;
            padding: 24px; max-width: 400px; width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation: pop 0.2s;
        }
        .modal-title { font-size: 20px; font-weight: 600; margin-bottom: 16px; }
        .modal-content { margin-bottom: 24px; }
        .modal-input {
            width: 100%; padding: 12px; background: var(--border-color);
            border: none; border-radius: 12px; color: var(--text-primary);
            margin-bottom: 16px;
        }
        .modal-buttons { display: flex; gap: 12px; justify-content: flex-end; }
        .modal-btn {
            padding: 10px 20px; border: none; border-radius: 12px;
            cursor: pointer; font-weight: 600; transition: opacity 0.2s;
        }
        .modal-btn.cancel { background: var(--border-color); color: var(--text-primary); }
        .modal-btn.confirm { background: var(--accent-color); color: #fff; }
        .modal-btn:hover { opacity: 0.8; }

        #recent-chats-sidebar {
            position: fixed; left: 0; top: 0; bottom: 0; width: 80px;
            background: var(--surface-color); border-right: 1px solid var(--border-color);
            overflow-y: auto; display: flex; flex-direction: column; align-items: center;
            padding: 8px 0; z-index: 100;
        }
        .recent-chat-avatar {
            width: 50px; height: 50px; border-radius: 50%;
            background: var(--accent-color); margin: 8px 0;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.2s; position: relative;
        }
        .recent-chat-avatar:hover { transform: scale(1.1); }
    </style>
</head>
<body>
<div id="app">
    <!-- –≠–∫—Ä–∞–Ω –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ -->
    <div id="auth-screen" class="screen active">
        <div class="auth-card">
            <div class="auth-avatar">üïäÔ∏è</div>
            <div class="auth-title">Zhuravlev Telegram</div>
            <div id="auth-buttons" class="auth-buttons">
                <button class="auth-btn register" onclick="showRegisterForm()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
                <button class="auth-btn login" onclick="showLoginForm()">–í—Ö–æ–¥</button>
            </div>
            <div id="register-form" class="auth-form">
                <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
                <input type="text" id="reg-username" placeholder="–Æ–∑–µ—Ä–Ω–µ–π–º (–±–µ–∑ @)">
                <input type="password" id="reg-password" placeholder="–ü–∞—Ä–æ–ª—å">
                <input type="password" id="reg-password2" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                <button onclick="register()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
                <div class="back-link" onclick="showAuthButtons()">‚Üê –ù–∞–∑–∞–¥</div>
            </div>
            <div id="login-form" class="auth-form">
                <h2>–í—Ö–æ–¥</h2>
                <input type="text" id="login-username" placeholder="–Æ–∑–µ—Ä–Ω–µ–π–º">
                <input type="password" id="login-password" placeholder="–ü–∞—Ä–æ–ª—å">
                <button onclick="login()">–í–æ–π—Ç–∏</button>
                <div class="back-link" onclick="showAuthButtons()">‚Üê –ù–∞–∑–∞–¥</div>
            </div>
        </div>
    </div>

    <!-- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω (–ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞) -->
    <div id="main-screen" class="screen">
        <div class="top-bar" id="top-bar">
            <h1 id="screen-title">–ß–∞—Ç—ã</h1>
            <button class="edit-btn" id="edit-btn" onclick="toggleEditMode()">–ò–∑–º.</button>
            <button class="create-btn" id="create-btn" onclick="showCreateGroupType()">üìù</button>
        </div>
        <div class="search-box" id="search-box">
            <input type="text" id="global-search" placeholder="–ü–æ–∏—Å–∫..." oninput="globalSearch()">
        </div>
        <div id="folders-row" class="folders-row"></div>
        <div id="edit-bar" class="edit-bar" style="display: none;">
            <div class="edit-counter" id="edit-counter">0 –≤—ã–±—Ä–∞–Ω–æ</div>
            <div class="edit-actions">
                <button onclick="deleteSelectedChats()">–£–¥–∞–ª–∏—Ç—å</button>
                <button onclick="pinSelectedChats()">–ó–∞–∫—Ä–µ–ø–∏—Ç—å</button>
                <button onclick="addToFolder()">–í –ø–∞–ø–∫—É</button>
                <button onclick="doneEditMode()">–ì–æ—Ç–æ–≤–æ</button>
            </div>
        </div>
        <div id="content-area" style="flex: 1; overflow-y: auto;">
            <div id="chats-view" class="view active"><div class="chats-list" id="chats-list"></div></div>
            <div id="contacts-view" class="view" style="display: none;"><div class="contacts-list" id="contacts-list"></div></div>
            <div id="settings-view" class="view" style="display: none;">
                <div class="settings-list">
                    <div class="settings-item" onclick="showProfile('me')">
                        <div class="settings-icon">üë§</div>
                        <div class="settings-content">
                            <div class="settings-title">–ü—Ä–æ—Ñ–∏–ª—å</div>
                            <div class="settings-subtitle">–ò–º—è, –∞–≤–∞—Ç–∞—Ä, –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è</div>
                        </div>
                    </div>
                    <div class="settings-item" onclick="showThemes()">
                        <div class="settings-icon">üé®</div>
                        <div class="settings-content">
                            <div class="settings-title">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</div>
                            <div class="settings-subtitle">–¢–µ–º—ã, –æ–±–æ–∏, —Ä–µ–∂–∏–º</div>
                        </div>
                        <div class="settings-value" id="current-theme">–¢—ë–º–Ω–∞—è</div>
                    </div>
                    <div class="settings-item" onclick="showPrivacy()">
                        <div class="settings-icon">üîí</div>
                        <div class="settings-content">
                            <div class="settings-title">–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å</div>
                            <div class="settings-subtitle">–ö—Ç–æ –≤–∏–¥–∏—Ç –Ω–æ–º–µ—Ä, —Ñ–æ—Ç–æ</div>
                        </div>
                    </div>
                    <div class="settings-item" onclick="showDevices()">
                        <div class="settings-icon">üì±</div>
                        <div class="settings-content">
                            <div class="settings-title">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</div>
                            <div class="settings-subtitle">–ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ–∞–Ω—Å—ã</div>
                        </div>
                    </div>
                    <div class="settings-item" onclick="showFolders()">
                        <div class="settings-icon">üìÅ</div>
                        <div class="settings-content">
                            <div class="settings-title">–ü–∞–ø–∫–∏ —Å —á–∞—Ç–∞–º–∏</div>
                            <div class="settings-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–ø–∫–∞–º–∏</div>
                        </div>
                    </div>
                    <div class="settings-item" onclick="showLanguage()">
                        <div class="settings-icon">üåê</div>
                        <div class="settings-content">
                            <div class="settings-title">–Ø–∑—ã–∫</div>
                            <div class="settings-subtitle">–†—É—Å—Å–∫–∏–π / English</div>
                        </div>
                        <div class="settings-value" id="current-lang">–†—É—Å—Å–∫–∏–π</div>
                    </div>
                    <div class="settings-item" onclick="showAbout()">
                        <div class="settings-icon">‚ÑπÔ∏è</div>
                        <div class="settings-content">
                            <div class="settings-title">–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</div>
                            <div class="settings-subtitle">–í–µ—Ä—Å–∏—è 10.1</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="chat-panel" style="display: none; flex-direction: column;">
            <div class="chat-header" onclick="openChatInfo()">
                <div class="chat-header-info">
                    <div class="chat-header-name" id="pc-chat-header-name">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div>
                    <div class="chat-header-status" id="pc-chat-header-status"></div>
                </div>
                <button class="edit-btn" onclick="event.stopPropagation(); toggleChatMenu()">‚ãÆ</button>
                <div class="chat-menu" id="pc-chat-menu"></div>
            </div>
            <div class="messages-area" id="pc-messages-area"></div>
            <div class="input-area">
                <button class="attach-btn" onclick="toggleAttachMenu()">üìé</button>
                <div class="input-wrapper">
                    <input type="text" id="pc-message-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" oninput="handleTyping(true)" onkeypress="handleEnterKey(event, true)">
                    <button class="emoji-btn" onclick="toggleEmojiPicker(true)">üòÄ</button>
                    <button class="voice-btn" id="pc-send-btn" onclick="sendMessage(true)">üé§</button>
                </div>
            </div>
        </div>
        <div class="bottom-nav">
            <div class="nav-item active" data-view="chats" onclick="switchMainView('chats')"><i>üí¨</i><span>–ß–∞—Ç—ã</span></div>
            <div class="nav-item" data-view="contacts" onclick="switchMainView('contacts')"><i>üë•</i><span>–ö–æ–Ω—Ç–∞–∫—Ç—ã</span></div>
            <div class="nav-item" data-view="settings" onclick="switchMainView('settings')"><i>‚öôÔ∏è</i><span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span></div>
        </div>
    </div>

    <!-- –û–∫–Ω–æ —á–∞—Ç–∞ (–º–æ–±–∏–ª—å–Ω–æ–µ) -->
    <div id="chat-window" class="screen">
        <div class="chat-header" onclick="openChatInfo()">
            <button class="back-btn" onclick="event.stopPropagation(); closeChat()">‚Üê</button>
            <div class="chat-header-info">
                <div class="chat-header-name" id="chat-header-name"></div>
                <div class="chat-header-status" id="chat-header-status">–æ–Ω–ª–∞–π–Ω</div>
            </div>
            <button class="edit-btn" style="margin-right: 0;" onclick="event.stopPropagation(); toggleChatMenu()">‚ãÆ</button>
            <div class="chat-menu" id="chat-menu"></div>
        </div>
        <div class="messages-area" id="messages-area"></div>
        <div class="input-area">
            <button class="attach-btn" onclick="toggleAttachMenu()">üìé</button>
            <div class="input-wrapper">
                <input type="text" id="message-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" oninput="handleTyping(false)" onkeypress="handleEnterKey(event, false)">
                <button class="emoji-btn" onclick="toggleEmojiPicker(false)">üòÄ</button>
                <button class="voice-btn" id="send-btn" onclick="sendMessage(false)">üé§</button>
            </div>
        </div>
        <input type="file" id="file-input" onchange="uploadFile()" style="display: none;">
        <div id="emoji-picker" class="emoji-picker" style="display: none;"></div>
        <div id="attach-menu" class="attach-menu" style="display: none;">
            <div class="attach-menu-item" onclick="attachPhoto()">üì∑ –§–æ—Ç–æ</div>
            <div class="attach-menu-item" onclick="attachVideo()">üé• –í–∏–¥–µ–æ</div>
            <div class="attach-menu-item" onclick="attachFile()">üìé –§–∞–π–ª</div>
            <div class="attach-menu-item" onclick="showPollScreen()">üìä –û–ø—Ä–æ—Å</div>
            <div class="attach-menu-item" onclick="attachVoice()">üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ</div>
        </div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω —Å–æ–∑–¥–∞–Ω–∏—è –æ–ø—Ä–æ—Å–∞ -->
    <div id="poll-screen" class="screen">
        <div class="top-bar">
            <button class="back-btn" onclick="hidePollScreen()">‚Üê</button>
            <h1>–°–æ–∑–¥–∞—Ç—å –æ–ø—Ä–æ—Å</h1>
            <button class="create-btn" onclick="createPoll()">–ì–æ—Ç–æ–≤–æ</button>
        </div>
        <div class="poll-screen" style="flex:1; overflow-y: auto;">
            <input type="text" id="poll-question" placeholder="–í–æ–ø—Ä–æ—Å">
            <div id="poll-options">
                <input type="text" id="poll-opt1" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 1">
                <input type="text" id="poll-opt2" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 2">
            </div>
            <button onclick="addPollOption()">+ –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç</button>
            <label><input type="checkbox" id="poll-multiple"> –ù–µ—Å–∫–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç–æ–≤</label>
            <label><input type="checkbox" id="poll-quiz"> –†–µ–∂–∏–º –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã</label>
        </div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é —Å–æ–æ–±—â–µ–Ω–∏—è -->
    <div id="message-context-menu" class="message-context-menu" style="display: none;">
        <div class="reactions-scroll" id="reaction-scroll">
            <span class="reaction-option" onclick="contextReact('üëç')">üëç</span>
            <span class="reaction-option" onclick="contextReact('‚ù§Ô∏è')">‚ù§Ô∏è</span>
            <span class="reaction-option" onclick="contextReact('üòÆ')">üòÆ</span>
            <span class="reaction-option" onclick="contextReact('üò¢')">üò¢</span>
            <span class="reaction-option" onclick="contextReact('üò°')">üò°</span>
            <span class="reaction-option" onclick="contextReact('üéâ')">üéâ</span>
        </div>
        <div class="message-context-item" onclick="contextReply()">‚Ü©Ô∏è –û—Ç–≤–µ—Ç–∏—Ç—å</div>
        <div class="message-context-item" onclick="contextForward()">‚û°Ô∏è –ü–µ—Ä–µ—Å–ª–∞—Ç—å</div>
        <div class="message-context-item" onclick="contextCopy()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</div>
        <div class="message-context-item" onclick="contextDelete()">‚ùå –£–¥–∞–ª–∏—Ç—å</div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã/–∫–∞–Ω–∞–ª–∞ (—à–∞–≥ 1) -->
    <div id="create-group-type-screen" class="screen">
        <div class="top-bar">
            <button class="back-btn" onclick="hideCreateGroupType()">‚Üê</button>
            <h1>–°–æ–∑–¥–∞—Ç—å</h1>
        </div>
        <div style="flex:1; overflow-y: auto; padding: 16px;">
            <div class="settings-item" onclick="startCreateGroup('channel')">
                <div class="settings-icon">üì¢</div>
                <div class="settings-content">
                    <div class="settings-title">–ö–∞–Ω–∞–ª</div>
                    <div class="settings-subtitle">–ü—É–±–ª–∏—á–Ω—ã–π –∏–ª–∏ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–∞–Ω–∞–ª</div>
                </div>
            </div>
            <div class="settings-item" onclick="startCreateGroup('group')">
                <div class="settings-icon">üë•</div>
                <div class="settings-content">
                    <div class="settings-title">–ì—Ä—É–ø–ø–∞</div>
                    <div class="settings-subtitle">–û–±—â–∞–π—Ç–µ—Å—å —Å –¥—Ä—É–∑—å—è–º–∏</div>
                </div>
            </div>
        </div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω —Å–æ–∑–¥–∞–Ω–∏—è (—à–∞–≥ 2: —É—á–∞—Å—Ç–Ω–∏–∫–∏) -->
    <div id="create-group-members-screen" class="screen">
        <div class="top-bar">
            <button class="back-btn" onclick="hideCreateGroupMembers()">‚Üê</button>
            <h1>–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h1>
            <button class="next-btn" onclick="nextCreateGroupStep()">‚û°Ô∏è</button>
        </div>
        <div class="participant-list" id="create-group-members-list"></div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω —Å–æ–∑–¥–∞–Ω–∏—è (—à–∞–≥ 3: –¥–µ—Ç–∞–ª–∏) -->
    <div id="create-group-detail-screen" class="screen">
        <div class="top-bar">
            <button class="back-btn" onclick="prevCreateGroupStep()">‚Üê</button>
            <h1 id="create-group-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
            <button class="next-btn" onclick="createGroupFinal()">‚úÖ</button>
        </div>
        <div style="flex:1; overflow-y: auto; padding: 16px;">
            <div style="text-align:center; margin-bottom:24px;">
                <div class="profile-avatar" id="create-group-avatar" onclick="chooseGroupAvatar()">üì∑</div>
                <button class="btn-secondary" onclick="chooseGroupAvatarEmoji()">–í—ã–±—Ä–∞—Ç—å —ç–º–æ–¥–∑–∏</button>
                <button class="btn-secondary" onclick="uploadGroupAvatar()">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</button>
            </div>
            <input type="text" id="create-group-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" style="width:100%; padding:12px; background:var(--surface-color); border:1px solid var(--border-color); border-radius:12px; color:var(--text-primary); margin-bottom:16px;">
            <textarea id="create-group-description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" style="width:100%; padding:12px; background:var(--surface-color); border:1px solid var(--border-color); border-radius:12px; color:var(--text-primary); margin-bottom:16px;"></textarea>
            <div style="display:flex; gap:12px; margin-bottom:16px;">
                <div class="privacy-btn" style="flex:1; padding:10px; background:var(--surface-color); border:1px solid var(--border-color); border-radius:12px; text-align:center; cursor:pointer;" onclick="selectCreatePrivacy('public')">–ü—É–±–ª–∏—á–Ω—ã–π</div>
                <div class="privacy-btn" style="flex:1; padding:10px; background:var(--surface-color); border:1px solid var(--border-color); border-radius:12px; text-align:center; cursor:pointer;" onclick="selectCreatePrivacy('private')">–ü—Ä–∏–≤–∞—Ç–Ω—ã–π</div>
            </div>
            <div id="create-group-link-container" style="display:none; margin-bottom:16px;">
                <label>–°—Å—ã–ª–∫–∞-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ</label>
                <div style="display:flex; gap:8px;">
                    <input type="text" id="create-group-link" readonly style="flex:1; padding:12px; background:var(--surface-color); border:1px solid var(--border-color); border-radius:12px; color:var(--text-primary);">
                    <button onclick="copyGroupLink()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
            </div>
            <div id="group-permissions" style="display: block;">
                <h3>–†–∞–∑—Ä–µ—à–µ–Ω–∏—è</h3>
                <label><input type="checkbox" id="perm-send-msg" checked> –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π</label><br>
                <label><input type="checkbox" id="perm-send-media" checked> –û—Ç–ø—Ä–∞–≤–∫–∞ –º–µ–¥–∏–∞</label><br>
                <label><input type="checkbox" id="perm-add-members" checked> –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</label><br>
                <label><input type="checkbox" id="perm-pin" checked> –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π</label>
            </div>
        </div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω –ø—Ä–æ—Ñ–∏–ª—è (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å/–≥—Ä—É–ø–ø–∞/–∫–∞–Ω–∞–ª) -->
    <div id="profile-screen" class="screen">
        <div class="top-bar">
            <button class="back-btn" onclick="hideProfile()">‚Üê</button>
            <h1 id="profile-title">–ü—Ä–æ—Ñ–∏–ª—å</h1>
            <button class="edit-btn" id="profile-edit-btn" style="display: none;" onclick="editProfile()">‚úèÔ∏è</button>
        </div>
        <div style="flex:1; overflow-y: auto;" id="profile-content"></div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è -->
    <div id="profile-edit-screen" class="screen">
        <div class="top-bar">
            <button class="back-btn" onclick="hideProfileEdit()">‚Üê</button>
            <h1>–ò–∑–º–µ–Ω–∏—Ç—å</h1>
            <button class="next-btn" onclick="saveProfileEdit()">üíæ</button>
        </div>
        <div style="flex:1; overflow-y: auto; padding:16px;" id="profile-edit-content"></div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω –ø–∞–ø–æ–∫ -->
    <div id="folders-screen" class="screen">
        <div class="top-bar">
            <button class="back-btn" onclick="hideFolders()">‚Üê</button>
            <h1>–ü–∞–ø–∫–∏</h1>
            <button class="create-btn" onclick="showCreateFolder()">‚ûï</button>
        </div>
        <div style="flex:1; overflow-y: auto; padding:16px;" id="folders-list"></div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞–ø–∫–∏ -->
    <div id="create-folder-screen" class="screen">
        <div class="top-bar">
            <button class="back-btn" onclick="hideCreateFolder()">‚Üê</button>
            <h1>–°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É</h1>
            <button class="next-btn" onclick="createFolderFinal()">‚úÖ</button>
        </div>
        <div style="flex:1; overflow-y: auto; padding:16px;">
            <input type="text" id="folder-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏" style="width:100%; padding:12px; background:var(--surface-color); border:1px solid var(--border-color); border-radius:12px; color:var(--text-primary); margin-bottom:16px;">
            <h3>–¶–≤–µ—Ç –º–µ—Ç–∫–∏</h3>
            <div class="color-picker" id="folder-color-picker">
                <div class="color-option black" onclick="selectFolderColor('black')"></div>
                <div class="color-option white" onclick="selectFolderColor('white')"></div>
                <div class="color-option yellow" onclick="selectFolderColor('yellow')"></div>
                <div class="color-option red" onclick="selectFolderColor('red')"></div>
                <div class="color-option blue" onclick="selectFolderColor('blue')"></div>
                <div class="color-option green" onclick="selectFolderColor('green')"></div>
                <div class="color-option orange" onclick="selectFolderColor('orange')"></div>
            </div>
            <h3>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç—ã</h3>
            <div id="folder-chat-select" style="max-height:300px; overflow-y:auto;"></div>
        </div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ø–∞–ø–∫–∏ -->
    <div id="folder-detail-screen" class="screen">
        <div class="top-bar">
            <button class="back-btn" onclick="hideFolderDetail()">‚Üê</button>
            <h1 id="folder-detail-title"></h1>
            <button class="edit-btn" onclick="editFolder()">–ò–∑–º.</button>
        </div>
        <div style="flex:1; overflow-y: auto; padding:16px;" id="folder-chats-list"></div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω —Ç–µ–º -->
    <div id="themes-screen" class="screen">
        <div class="top-bar">
            <button class="back-btn" onclick="hideThemes()">‚Üê</button>
            <h1>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</h1>
        </div>
        <div style="flex:1; overflow-y: auto; padding:16px;">
            <h3>–¢–µ–º–∞</h3>
            <div class="theme-option" onclick="selectTheme('dark')">–¢—ë–º–Ω–∞—è</div>
            <div class="theme-option" onclick="selectTheme('light')">–°–≤–µ—Ç–ª–∞—è</div>
            <div class="theme-option" onclick="selectTheme('blue')">–°–∏–Ω—è—è</div>
            <div class="theme-option" onclick="selectTheme('green')">–ó–µ–ª—ë–Ω–∞—è</div>
            <div class="theme-option" onclick="selectTheme('purple')">–§–∏–æ–ª–µ—Ç–æ–≤–∞—è</div>
            <h3>–û–±–æ–∏ —á–∞—Ç–∞</h3>
            <div class="theme-option" onclick="selectWallpaper('default')">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</div>
            <div class="theme-option" onclick="selectWallpaper('light')">–°–≤–µ—Ç–ª—ã–µ</div>
            <div class="theme-option" onclick="selectWallpaper('dark')">–¢—ë–º–Ω—ã–µ</div>
            <div class="theme-option" onclick="selectWallpaper('gradient')">–ì—Ä–∞–¥–∏–µ–Ω—Ç</div>
            <div class="theme-option" onclick="selectWallpaper('pattern')">–£–∑–æ—Ä</div>
            <h3>–†–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</h3>
            <div class="theme-option" onclick="setDesktopMode(true)">–ö–æ–º–ø—å—é—Ç–µ—Ä–Ω–∞—è –≤–µ—Ä—Å–∏—è</div>
            <div class="theme-option" onclick="setDesktopMode(false)">–¢–µ–ª–µ—Ñ–æ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è</div>
        </div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ -->
    <div id="privacy-screen" class="screen">
        <div class="top-bar">
            <button class="back-btn" onclick="hidePrivacy()">‚Üê</button>
            <h1>–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å</h1>
        </div>
        <div style="flex:1; overflow-y: auto; padding:16px;">
            <div class="privacy-item" onclick="cyclePrivacy('phone')">
                <span>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</span>
                <span class="privacy-value" id="privacy-phone">–í—Å–µ</span>
            </div>
            <div class="privacy-item" onclick="cyclePrivacy('lastSeen')">
                <span>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥</span>
                <span class="privacy-value" id="privacy-lastSeen">–í—Å–µ</span>
            </div>
            <div class="privacy-item" onclick="cyclePrivacy('photo')">
                <span>–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è</span>
                <span class="privacy-value" id="privacy-photo">–í—Å–µ</span>
            </div>
            <div class="privacy-item" onclick="cyclePrivacy('status')">
                <span>–°—Ç–∞—Ç—É—Å</span>
                <span class="privacy-value" id="privacy-status">–í—Å–µ</span>
            </div>
            <div class="privacy-item" onclick="cyclePrivacy('groups')">
                <span>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—ã</span>
                <span class="privacy-value" id="privacy-groups">–í—Å–µ</span>
            </div>
            <div class="privacy-item" onclick="cyclePrivacy('calls')">
                <span>–ó–≤–æ–Ω–∫–∏</span>
                <span class="privacy-value" id="privacy-calls">–í—Å–µ</span>
            </div>
        </div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω —É—Å—Ç—Ä–æ–π—Å—Ç–≤ -->
    <div id="devices-screen" class="screen">
        <div class="top-bar">
            <button class="back-btn" onclick="hideDevices()">‚Üê</button>
            <h1>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</h1>
            <button class="edit-btn" onclick="terminateOtherSessions()">–ó–∞–≤–µ—Ä—à–∏—Ç—å –≤—Å–µ –¥—Ä—É–≥–∏–µ —Å–µ–∞–Ω—Å—ã</button>
        </div>
        <div style="flex:1; overflow-y: auto; padding:16px;" id="devices-list"></div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω —è–∑—ã–∫–∞ -->
    <div id="language-screen" class="screen">
        <div class="top-bar">
            <button class="back-btn" onclick="hideLanguage()">‚Üê</button>
            <h1>–Ø–∑—ã–∫</h1>
        </div>
        <div style="flex:1; overflow-y: auto; padding:16px;">
            <div class="lang-option" onclick="selectLanguage('ru')">–†—É—Å—Å–∫–∏–π</div>
            <div class="lang-option" onclick="selectLanguage('en')">English</div>
        </div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω "–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏" -->
    <div id="about-screen" class="screen">
        <div class="top-bar">
            <button class="back-btn" onclick="hideAbout()">‚Üê</button>
            <h1>–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</h1>
        </div>
        <div style="flex:1; overflow-y: auto; padding:16px; text-align:center;">
            <p>Zhuravlev Telegram Clone v10.1</p>
            <p>–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: 01.03.2026</p>
            <p>–ê–≤—Ç–æ—Ä: –ú–∏—Ö–∞–∏–ª –ñ—É—Ä–∞–≤–ª–µ–≤</p>
            <p>–ê–∫–∫–∞—É–Ω—Ç–æ–≤: <span id="account-count">1</span></p>
        </div>
    </div>

    <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —á–∞—Ç–æ–≤ (–ü–ö) -->
    <div id="recent-chats-sidebar" style="display: none;"></div>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
    <div id="modal-overlay" class="modal-overlay">
        <div class="modal" id="modal">
            <div class="modal-title" id="modal-title"></div>
            <div class="modal-content" id="modal-content"></div>
            <input type="text" class="modal-input" id="modal-input" style="display:none;">
            <div class="modal-buttons" id="modal-buttons"></div>
        </div>
    </div>
</div>

<script>
    // ==================== –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï ====================
    let appState = {
        accounts: JSON.parse(localStorage.getItem('accounts')) || [],
        currentAccount: null,
        theme: localStorage.getItem('theme') || 'dark',
        wallpaper: localStorage.getItem('wallpaper') || 'default',
        desktopMode: localStorage.getItem('desktopMode') === 'true' ? true : (window.innerWidth >= 768),
        language: localStorage.getItem('language') || 'ru',
        privacy: JSON.parse(localStorage.getItem('privacy')) || {
            phone: 'everyone', lastSeen: 'everyone', photo: 'everyone',
            status: 'everyone', groups: 'everyone', calls: 'everyone'
        },
        folders: JSON.parse(localStorage.getItem('folders')) || [],
        chats: JSON.parse(localStorage.getItem('chats')) || [
            { id: 'bot', type: 'private', name: 'Zhuravlev Bot', avatar: 'ü§ñ', participants: ['me', 'bot'], lastMessage: '–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç', lastTime: Date.now() - 3600000, unread: 0, pinned: false, public: true },
            { id: 'friends', type: 'group', name: '–î—Ä—É–∑—å—è', avatar: 'üë•', participants: ['me', 'user1', 'user2', 'user3'], lastMessage: '–ê–Ω—Ç–æ–Ω: –ü—Ä–∏–≤–µ—Ç!', lastTime: Date.now() - 7200000, unread: 2, pinned: true, public: true },
            { id: 'work', type: 'group', name: '–†–∞–±–æ—Ç–∞', avatar: 'üíº', participants: ['me', 'user4', 'user5'], lastMessage: '–°–æ–±—Ä–∞–Ω–∏–µ –≤ 15:00', lastTime: Date.now() - 10800000, unread: 0, pinned: false, public: true },
            { id: 'channel1', type: 'channel', name: '–ù–æ–≤–æ—Å—Ç–∏ Tech', avatar: 'üì∞', participants: ['me', 'user1', 'user2'], lastMessage: '–í—ã—à–ª–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è', lastTime: Date.now() - 1800000, unread: 1, pinned: false, public: true }
        ],
        users: JSON.parse(localStorage.getItem('users')) || [
            { id: 'user1', name: '–ê–Ω—Ç–æ–Ω', username: 'anton', avatar: 'A', lastSeen: Date.now() - 3600000, online: false, phone: '+7 900 111-22-33', birthday: '1990-01-01' },
            { id: 'user2', name: '–ú–∞—Ä–∏—è', username: 'maria', avatar: 'M', lastSeen: Date.now() - 7200000, online: false, phone: '+7 900 222-33-44', birthday: '1992-02-02' },
            { id: 'user3', name: '–ò–≤–∞–Ω', username: 'ivan', avatar: '–ò', lastSeen: Date.now() - 1800000, online: true, phone: '+7 900 333-44-55', birthday: '1988-03-03' },
            { id: 'user4', name: '–ï–ª–µ–Ω–∞', username: 'elena', avatar: '–ï', lastSeen: Date.now() - 86400000, online: false, phone: '+7 900 444-55-66', birthday: '1995-04-04' },
            { id: 'user5', name: '–ü—ë—Ç—Ä', username: 'petr', avatar: '–ü', lastSeen: Date.now() - 300000, online: true, phone: '+7 900 555-66-77', birthday: '1985-05-05' },
            { id: 'bot', name: 'Zhuravlev Bot', username: 'bot', avatar: 'ü§ñ', lastSeen: Date.now() - 100000, online: true, phone: '' }
        ],
        messages: JSON.parse(localStorage.getItem('messages')) || {
            'bot': [
                { id: 'b1', senderId: 'bot', content: 'üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Zhuravlev Telegram!', time: Date.now() - 86400000, type: 'text', reactions: [] },
                { id: 'b2', senderId: 'bot', content: '–Ø –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –±–æ—Ç-–ø–æ–º–æ—â–Ω–∏–∫. –ú–æ–≥—É –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ñ–∞–π–ª—ã, –ø—Ä–æ–≤–æ–¥–∏—Ç—å –æ–ø—Ä–æ—Å—ã.', time: Date.now() - 86000000, type: 'text', reactions: [] },
                { id: 'b3', senderId: 'bot', content: '–ù–∞–ø–∏—à–∏—Ç–µ –º–Ω–µ —á—Ç–æ-–Ω–∏–±—É–¥—å, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏.', time: Date.now() - 85000000, type: 'text', reactions: [] },
            ],
            'friends': [
                { id: 'f1', senderId: 'user1', content: '–ü—Ä–∏–≤–µ—Ç!', time: Date.now() - 7200000, type: 'text', reactions: [] },
                { id: 'f2', senderId: 'user2', content: '–ö–∞–∫ –¥–µ–ª–∞?', time: Date.now() - 7100000, type: 'text', reactions: [] },
            ],
            'work': [
                { id: 'w1', senderId: 'user4', content: '–°–æ–±—Ä–∞–Ω–∏–µ –≤ 15:00', time: Date.now() - 10800000, type: 'text', reactions: [] },
            ],
            'channel1': [
                { id: 'c1', senderId: 'me', content: '–í—ã—à–ª–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è Telegram', time: Date.now() - 1800000, type: 'text', reactions: [] },
            ],
        },
        localNames: JSON.parse(localStorage.getItem('localNames')) || {},
        me: null,
        currentChatId: null,
        editMode: false,
        selectedChats: [],
        contextMessage: null,
        groupType: 'group',
        groupPrivacy: 'public',
        groupAvatar: 'üì∑',
        groupName: '',
        groupDescription: '',
        groupLink: '',
        selectedParticipants: [],
        createStep: 1,
        currentProfileUserId: null,
        currentProfileChatId: null,
        currentFolderId: null,
        folderColor: 'black',
        activeFolderId: 'all',
        isMobile: window.innerWidth < 768,
        searchResults: [],
        recentChats: [],
        pollOptions: ['', ''],
        pollMultiple: false,
        pollQuiz: false
    };

    // –ü–µ—Ä–µ–≤–æ–¥—ã
    const i18n = {
        ru: {
            chats: '–ß–∞—Ç—ã', contacts: '–ö–æ–Ω—Ç–∞–∫—Ç—ã', settings: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏',
            edit: '–ò–∑–º.', search: '–ü–æ–∏—Å–∫...', selected: '–≤—ã–±—Ä–∞–Ω–æ',
            delete: '–£–¥–∞–ª–∏—Ç—å', pin: '–ó–∞–∫—Ä–µ–ø–∏—Ç—å', addToFolder: '–í –ø–∞–ø–∫—É',
            done: '–ì–æ—Ç–æ–≤–æ', profile: '–ü—Ä–æ—Ñ–∏–ª—å', appearance: '–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ',
            privacy: '–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å', devices: '–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞',
            folders: '–ü–∞–ø–∫–∏ —Å —á–∞—Ç–∞–º–∏', language: '–Ø–∑—ã–∫', about: '–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏',
            create: '–°–æ–∑–¥–∞—Ç—å', channel: '–ö–∞–Ω–∞–ª', group: '–ì—Ä—É–ø–ø–∞',
            addMembers: '–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤', chooseEmoji: '–í—ã–±—Ä–∞—Ç—å —ç–º–æ–¥–∑–∏',
            uploadPhoto: '–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ', inviteLink: '–°—Å—ã–ª–∫–∞-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ',
            copy: '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å', permissions: '–†–∞–∑—Ä–µ—à–µ–Ω–∏—è',
            createFolder: '–°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É', folderColor: '–¶–≤–µ—Ç –º–µ—Ç–∫–∏',
            selectChats: '–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç—ã', theme: '–¢–µ–º–∞', wallpaper: '–û–±–æ–∏ —á–∞—Ç–∞',
            displayMode: '–†–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è', phoneNumber: '–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞',
            lastSeen: '–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥', profilePhoto: '–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è',
            status: '–°—Ç–∞—Ç—É—Å', addToGroups: '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—ã',
            calls: '–ó–≤–æ–Ω–∫–∏', updated: '–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: 01.03.2026',
            author: '–ê–≤—Ç–æ—Ä: –ú–∏—Ö–∞–∏–ª –ñ—É—Ä–∞–≤–ª–µ–≤', accountsCount: '–ê–∫–∫–∞—É–Ω—Ç–æ–≤:'
        },
        en: {
            chats: 'Chats', contacts: 'Contacts', settings: 'Settings',
            edit: 'Edit', search: 'Search...', selected: 'selected',
            delete: 'Delete', pin: 'Pin', addToFolder: 'Add to folder',
            done: 'Done', profile: 'Profile', appearance: 'Appearance',
            privacy: 'Privacy', devices: 'Devices', folders: 'Folders',
            language: 'Language', about: 'About', create: 'Create',
            channel: 'Channel', group: 'Group', addMembers: 'Add members',
            chooseEmoji: 'Choose emoji', uploadPhoto: 'Upload photo',
            inviteLink: 'Invite link', copy: 'Copy', permissions: 'Permissions',
            createFolder: 'Create folder', folderColor: 'Folder color',
            selectChats: 'Select chats', theme: 'Theme', wallpaper: 'Chat wallpaper',
            displayMode: 'Display mode', phoneNumber: 'Phone number',
            lastSeen: 'Last seen', profilePhoto: 'Profile photo',
            status: 'Status', addToGroups: 'Add to groups', calls: 'Calls',
            updated: 'Updated: 01.03.2026', author: 'Author: Mikhail Zhuravlev',
            accountsCount: 'Accounts:'
        }
    };
    function t(key) { return i18n[appState.language][key] || key; }

    function applyTranslations() {
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            el.innerText = t(key);
        });
        document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
            const key = el.getAttribute('data-i18n-placeholder');
            el.placeholder = t(key);
        });
        document.getElementById('screen-title').innerText = t('chats');
        document.getElementById('edit-btn').innerText = t('edit');
        document.querySelectorAll('.nav-item span').forEach((el, idx) => {
            if (idx === 0) el.innerText = t('chats');
            else if (idx === 1) el.innerText = t('contacts');
            else el.innerText = t('settings');
        });
    }

    function saveState() {
        localStorage.setItem('theme', appState.theme);
        localStorage.setItem('wallpaper', appState.wallpaper);
        localStorage.setItem('desktopMode', appState.desktopMode);
        localStorage.setItem('language', appState.language);
        localStorage.setItem('privacy', JSON.stringify(appState.privacy));
        localStorage.setItem('folders', JSON.stringify(appState.folders));
        localStorage.setItem('chats', JSON.stringify(appState.chats));
        localStorage.setItem('users', JSON.stringify(appState.users));
        localStorage.setItem('messages', JSON.stringify(appState.messages));
        localStorage.setItem('localNames', JSON.stringify(appState.localNames));
        localStorage.setItem('accounts', JSON.stringify(appState.accounts));
    }

    function applyThemeAndWallpaper() {
        document.body.className = appState.theme + '-theme';
        document.body.classList.add('wallpaper-' + appState.wallpaper);
        document.getElementById('current-theme').innerText = 
            appState.theme === 'dark' ? '–¢—ë–º–Ω–∞—è' :
            appState.theme === 'light' ? '–°–≤–µ—Ç–ª–∞—è' :
            appState.theme === 'blue' ? '–°–∏–Ω—è—è' :
            appState.theme === 'green' ? '–ó–µ–ª—ë–Ω–∞—è' : '–§–∏–æ–ª–µ—Ç–æ–≤–∞—è';
    }

    // === –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê ===
    function showModal({ title, content, input = false, onConfirm, onCancel }) {
        const overlay = document.getElementById('modal-overlay');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalInput = document.getElementById('modal-input');
        const modalButtons = document.getElementById('modal-buttons');

        modalTitle.innerText = title;
        modalContent.innerText = content;
        if (input) {
            modalInput.style.display = 'block';
            modalInput.value = '';
        } else {
            modalInput.style.display = 'none';
        }

        modalButtons.innerHTML = '';
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'modal-btn cancel';
        cancelBtn.innerText = '–û—Ç–º–µ–Ω–∞';
        cancelBtn.onclick = () => {
            overlay.style.display = 'none';
            if (onCancel) onCancel();
        };
        modalButtons.appendChild(cancelBtn);

        const confirmBtn = document.createElement('button');
        confirmBtn.className = 'modal-btn confirm';
        confirmBtn.innerText = '–û–ö';
        confirmBtn.onclick = () => {
            const val = input ? modalInput.value : null;
            overlay.style.display = 'none';
            if (onConfirm) onConfirm(val);
        };
        modalButtons.appendChild(confirmBtn);

        overlay.style.display = 'flex';
    }

    function showAlert(message) {
        showModal({ title: '–í–Ω–∏–º–∞–Ω–∏–µ', content: message, onConfirm: () => {} });
    }

    function showConfirm(message, callback) {
        showModal({
            title: '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ',
            content: message,
            onConfirm: (val) => { if (callback) callback(true); },
            onCancel: () => { if (callback) callback(false); }
        });
    }

    function showPrompt(message, defaultValue, callback) {
        showModal({
            title: message,
            content: '',
            input: true,
            onConfirm: (val) => { callback(val); },
            onCancel: () => { callback(null); }
        });
        if (defaultValue) document.getElementById('modal-input').value = defaultValue;
    }

    // === –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø ===
    function showRegisterForm() {
        document.getElementById('auth-buttons').style.display = 'none';
        document.getElementById('register-form').classList.add('active');
        document.getElementById('login-form').classList.remove('active');
    }

    function showLoginForm() {
        document.getElementById('auth-buttons').style.display = 'none';
        document.getElementById('login-form').classList.add('active');
        document.getElementById('register-form').classList.remove('active');
    }

    function showAuthButtons() {
        document.getElementById('auth-buttons').style.display = 'flex';
        document.getElementById('register-form').classList.remove('active');
        document.getElementById('login-form').classList.remove('active');
    }

    function register() {
        const username = document.getElementById('reg-username').value.trim();
        const password = document.getElementById('reg-password').value;
        const password2 = document.getElementById('reg-password2').value;

        if (!username || !password || !password2) {
            showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
            return;
        }
        if (password !== password2) {
            showAlert('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
            return;
        }
        if (appState.accounts.find(a => a.username === username)) {
            showAlert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º —é–∑–µ—Ä–Ω–µ–π–º–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
            return;
        }

        const newAccount = { username, password, name: username, avatar: 'üë§', birthday: '' };
        appState.accounts.push(newAccount);
        appState.currentAccount = username;
        appState.me = { id: username, name: username, username, avatar: 'üë§', birthday: '', phone: '' };
        saveState();
        showMainScreen();
    }

    function login() {
        const username = document.getElementById('login-username').value.trim();
        const password = document.getElementById('login-password').value;
        const account = appState.accounts.find(a => a.username === username && a.password === password);
        if (account) {
            appState.currentAccount = username;
            appState.me = { id: username, name: username, username, avatar: 'üë§', birthday: '', phone: '' };
            showMainScreen();
        } else {
            showAlert('–ù–µ–≤–µ—Ä–Ω—ã–π —é–∑–µ—Ä–Ω–µ–π–º –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
        }
    }

    function showMainScreen() {
        document.getElementById('auth-screen').classList.remove('active');
        document.getElementById('main-screen').classList.add('active');
        applyThemeAndWallpaper();
        applyTranslations();
        renderChats();
        renderContacts();
        updateRecentChats();
        renderFoldersRow();
        document.body.classList.toggle('pc-mode', appState.desktopMode && !appState.isMobile);
        document.body.classList.toggle('mobile-mode', !appState.desktopMode || appState.isMobile);
    }

    // === –ù–ê–í–ò–ì–ê–¶–ò–Ø ===
    let currentMainView = 'chats';
    let screenStack = ['main-screen'];

    function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
        screenStack.push(screenId);
    }

    function goBack() {
        if (screenStack.length > 1) {
            screenStack.pop();
            const prev = screenStack[screenStack.length - 1];
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(prev).classList.add('active');
        }
    }

    function switchMainView(view) {
        currentMainView = view;
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        document.querySelector(`[data-view="${view}"]`).classList.add('active');

        document.getElementById('chats-view').style.display = view === 'chats' ? 'block' : 'none';
        document.getElementById('contacts-view').style.display = view === 'contacts' ? 'block' : 'none';
        document.getElementById('settings-view').style.display = view === 'settings' ? 'block' : 'none';

        document.getElementById('screen-title').innerText = view === 'chats' ? t('chats') : view === 'contacts' ? t('contacts') : t('settings');
        document.getElementById('edit-btn').style.display = view === 'chats' ? 'inline-block' : 'none';
        document.getElementById('create-btn').style.display = view === 'chats' ? 'inline-block' : 'none';
        document.getElementById('search-box').style.display = view === 'chats' ? 'block' : 'none';

        if (view === 'chats') renderChats();
        if (view === 'contacts') renderContacts();
    }

    // === –ü–ê–ü–ö–ò ===
    function renderFoldersRow() {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–ø–∫–∏ —Ç–æ–ª—å–∫–æ –≤–æ –≤–∫–ª–∞–¥–∫–µ —á–∞—Ç–æ–≤
        if (currentMainView !== 'chats') {
            document.getElementById('folders-row').style.display = 'none';
            return;
        }
        document.getElementById('folders-row').style.display = 'flex';
        const row = document.getElementById('folders-row');
        row.innerHTML = '<div class="folder-chip ' + (appState.activeFolderId === 'all' ? 'active' : '') + '" onclick="selectFolder(\'all\')">–í—Å–µ</div>';
        appState.folders.forEach(folder => {
            const chip = document.createElement('div');
            chip.className = 'folder-chip' + (appState.activeFolderId === folder.id ? ' active' : '');
            chip.innerText = folder.name;
            chip.onclick = () => selectFolder(folder.id);
            row.appendChild(chip);
        });
    }

    function selectFolder(folderId) {
        appState.activeFolderId = folderId;
        renderFoldersRow();
        renderChats();
    }

    // === –ß–ê–¢–´ ===
    function renderChats() {
        const list = document.getElementById('chats-list');
        list.innerHTML = '';
        const filter = document.getElementById('global-search').value.toLowerCase();

        let visibleChats = appState.chats.filter(c => c.public || c.participants.includes(appState.currentAccount));
        if (appState.activeFolderId !== 'all') {
            const folder = appState.folders.find(f => f.id === appState.activeFolderId);
            if (folder) visibleChats = visibleChats.filter(c => folder.chats.includes(c.id));
        }

        const pinned = visibleChats.filter(c => c.pinned && c.name.toLowerCase().includes(filter));
        const others = visibleChats.filter(c => !c.pinned && c.name.toLowerCase().includes(filter));

        [...pinned, ...others].forEach(chat => {
            const item = document.createElement('div');
            item.className = `chat-item ${chat.pinned ? 'pinned' : ''} ${appState.editMode ? 'edit-mode' : ''}`;
            item.dataset.id = chat.id;
            item.onclick = (e) => {
                if (appState.editMode) toggleSelectChat(chat.id, e);
                else openChat(chat.id);
            };
            item.oncontextmenu = (e) => { e.preventDefault(); showChatContextMenu(e, chat.id); };
            if (appState.editMode) {
                const checkbox = document.createElement('div');
                checkbox.className = `chat-checkbox ${appState.selectedChats.includes(chat.id) ? 'selected' : ''}`;
                checkbox.innerText = appState.selectedChats.includes(chat.id) ? '‚úì' : '';
                item.appendChild(checkbox);
            }

            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'chat-avatar';
            avatarDiv.innerHTML = chat.avatar.startsWith('<img') ? chat.avatar : `<span>${chat.avatar}</span>`;
            if (chat.type === 'private') {
                const otherId = chat.participants.find(p => p !== appState.currentAccount);
                const user = appState.users.find(u => u.id === otherId);
                if (user && user.online) {
                    const online = document.createElement('span');
                    online.className = 'online-indicator';
                    avatarDiv.appendChild(online);
                }
            }

            const infoDiv = document.createElement('div');
            infoDiv.className = 'chat-info';
            let displayName = chat.name;
            if (chat.type === 'private') {
                const otherId = chat.participants.find(p => p !== appState.currentAccount);
                if (otherId && appState.localNames[otherId]) displayName += ` (${appState.localNames[otherId]})`;
            }
            let lastMsg = chat.lastMessage || '';
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            if (lastMsg) {
                if (chat.type === 'private') {
                    const otherId = chat.participants.find(p => p !== appState.currentAccount);
                    const lastMsgObj = appState.messages[chat.id]?.slice().reverse().find(m => m);
                    if (lastMsgObj && lastMsgObj.senderId === appState.currentAccount) {
                        lastMsg = '–í—ã: ' + lastMsg;
                    }
                } else if (chat.type === 'group') {
                    // —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
                } // –∫–∞–Ω–∞–ª –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
            }
            infoDiv.innerHTML = `<div class="chat-name">${displayName}</div><div class="chat-last-msg">${lastMsg}</div>`;

            // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫–∏ –ø–∞–ø–æ–∫
            const folderTags = [];
            appState.folders.forEach(f => {
                if (f.chats && f.chats.includes(chat.id)) {
                    folderTags.push(`<span class="folder-tag" style="background:${f.color === 'black' ? '#000' : f.color === 'white' ? '#fff' : f.color === 'yellow' ? '#ff0' : f.color === 'red' ? '#f00' : f.color === 'blue' ? '#00f' : f.color === 'green' ? '#0f0' : '#ffa500'};"></span>`);
                }
            });
            const tagsHtml = folderTags.join('');

            const metaDiv = document.createElement('div');
            metaDiv.className = 'chat-meta';
            metaDiv.innerHTML = `
                <div class="chat-time">${formatTime(chat.lastTime)}</div>
                ${chat.unread ? `<div class="chat-unread">${chat.unread}</div>` : ''}
                ${chat.pinned ? '<span class="chat-pin">üìå</span>' : ''}
                ${tagsHtml}
            `;

            item.appendChild(avatarDiv);
            item.appendChild(infoDiv);
            item.appendChild(metaDiv);
            list.appendChild(item);
        });
    }

    function formatTime(timestamp) {
        const d = new Date(timestamp);
        return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function globalSearch() {
        const query = document.getElementById('global-search').value.toLowerCase();
        if (query.length < 2) {
            renderChats();
            renderContacts();
            appState.searchResults = [];
            return;
        }
        const results = [];
        appState.chats.forEach(chat => {
            if (chat.name.toLowerCase().includes(query) || (chat.type === 'private' && chat.participants.find(p => p !== appState.currentAccount && p.toLowerCase().includes(query)))) {
                results.push({ type: 'chat', chatId: chat.id });
            }
        });
        appState.users.forEach(user => {
            if (user.username.toLowerCase().includes(query) || user.name.toLowerCase().includes(query)) {
                results.push({ type: 'user', userId: user.id });
            }
        });
        Object.entries(appState.messages).forEach(([chatId, msgs]) => {
            msgs.forEach(msg => {
                if (msg.content.toLowerCase().includes(query)) {
                    results.push({ type: 'message', chatId, msgId: msg.id, content: msg.content });
                }
            });
        });
        appState.searchResults = results;
        renderSearchResults(results);
    }

    function renderSearchResults(results) {
        const list = document.getElementById('chats-list');
        list.innerHTML = '';
        results.forEach(r => {
            if (r.type === 'chat') {
                const chat = appState.chats.find(c => c.id === r.chatId);
                if (!chat) return;
                const item = document.createElement('div');
                item.className = 'chat-item';
                item.onclick = () => openChat(chat.id);
                item.innerHTML = `<div class="chat-avatar">${chat.avatar}</div><div class="chat-info"><div class="chat-name">${chat.name}</div><div class="chat-last-msg">${chat.lastMessage}</div></div>`;
                list.appendChild(item);
            } else if (r.type === 'user') {
                const user = appState.users.find(u => u.id === r.userId);
                if (!user) return;
                const item = document.createElement('div');
                item.className = 'chat-item';
                item.onclick = () => openPrivateChat(user.id);
                item.innerHTML = `<div class="chat-avatar">${user.avatar}</div><div class="chat-info"><div class="chat-name">${user.name}</div><div class="chat-last-msg">@${user.username}</div></div>`;
                list.appendChild(item);
            } else if (r.type === 'message') {
                const chat = appState.chats.find(c => c.id === r.chatId);
                if (!chat) return;
                const item = document.createElement('div');
                item.className = 'chat-item';
                item.onclick = () => openChatWithHighlight(r.chatId, r.msgId);
                item.innerHTML = `<div class="chat-avatar">${chat.avatar}</div><div class="chat-info"><div class="chat-name">${chat.name}</div><div class="chat-last-msg">${r.content.substring(0,50)}...</div></div>`;
                list.appendChild(item);
            }
        });
        if (results.length === 0) list.innerHTML = '<div style="text-align:center; padding:20px;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
    }

    function openPrivateChat(userId) {
        let chat = appState.chats.find(c => c.type === 'private' && c.participants.includes(userId) && c.participants.includes(appState.currentAccount));
        if (!chat) {
            const user = appState.users.find(u => u.id === userId);
            chat = {
                id: 'private' + Date.now(),
                type: 'private',
                name: user.name,
                avatar: user.avatar,
                participants: [appState.currentAccount, userId],
                lastMessage: '',
                lastTime: Date.now(),
                unread: 0,
                pinned: false,
                public: true
            };
            appState.chats.push(chat);
            appState.messages[chat.id] = [];
            saveState();
        }
        openChat(chat.id);
    }

    function openChatWithHighlight(chatId, msgId) {
        openChat(chatId);
        setTimeout(() => {
            const msgEl = document.querySelector(`[data-id="${msgId}"]`);
            if (msgEl) {
                msgEl.style.backgroundColor = 'var(--accent-color)';
                msgEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(() => msgEl.style.backgroundColor = '', 2000);
            }
        }, 200);
    }

    function showChatContextMenu(e, chatId) {
        e.preventDefault();
        const menu = document.createElement('div');
        menu.className = 'message-context-menu';
        menu.style.left = e.pageX + 'px';
        menu.style.top = e.pageY + 'px';
        menu.innerHTML = `
            <div class="message-context-item" onclick="pinChat('${chatId}')">üìå –ó–∞–∫—Ä–µ–ø–∏—Ç—å</div>
            <div class="message-context-item" onclick="muteChat('${chatId}')">üîï –í—ã–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
            <div class="message-context-item" onclick="showDeleteOptions('${chatId}')">‚ùå –£–¥–∞–ª–∏—Ç—å</div>
            <div class="message-context-item" onclick="showAddToFolder('${chatId}')">üìÅ –î–æ–±–∞–≤–∏—Ç—å –≤ –ø–∞–ø–∫—É</div>
            <div class="message-context-item" onclick="blockUserFromChat('${chatId}')">üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</div>
        `;
        document.body.appendChild(menu);
        setTimeout(() => {
            document.addEventListener('click', function remove() {
                menu.remove();
                document.removeEventListener('click', remove);
            }, { once: true });
        }, 10);
    }

    function showDeleteOptions(chatId) {
        showConfirm('–£–¥–∞–ª–∏—Ç—å —É —Å–µ–±—è –∏–ª–∏ —É –≤—Å–µ—Ö? (OK - —É –≤—Å–µ—Ö, –û—Ç–º–µ–Ω–∞ - —É —Å–µ–±—è)', (ok) => {
            if (ok) {
                // –£–¥–∞–ª–∏—Ç—å —É –≤—Å–µ—Ö
                appState.chats = appState.chats.filter(c => c.id !== chatId);
                delete appState.messages[chatId];
            } else {
                // –£–¥–∞–ª–∏—Ç—å —Ç–æ–ª—å–∫–æ —É —Å–µ–±—è (—É–±–∏—Ä–∞–µ–º —Å–µ–±—è –∏–∑ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤)
                const chat = appState.chats.find(c => c.id === chatId);
                if (chat) {
                    chat.participants = chat.participants.filter(p => p !== appState.currentAccount);
                }
            }
            saveState();
            renderChats();
        });
    }

    function showAddToFolder(chatId) {
        const folderNames = appState.folders.map(f => f.name).join(', ');
        if (folderNames) {
            const msg = '–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫–∏ (–≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):\n' + folderNames;
            showPrompt(msg, '', (input) => {
                if (input) {
                    const selected = input.split(',').map(s => s.trim());
                    selected.forEach(name => {
                        const folder = appState.folders.find(f => f.name === name);
                        if (folder) {
                            if (!folder.chats) folder.chats = [];
                            if (!folder.chats.includes(chatId)) folder.chats.push(chatId);
                        }
                    });
                    saveState();
                    renderChats();
                }
            });
        } else {
            showAlert('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –ø–∞–ø–∫–∏');
        }
    }

    function pinChat(chatId) {
        const chat = appState.chats.find(c => c.id === chatId);
        if (chat) chat.pinned = !chat.pinned;
        saveState();
        renderChats();
    }

    function muteChat(chatId) {
        showAlert('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–∫–ª—é—á–µ–Ω—ã (—ç–º—É–ª—è—Ü–∏—è)');
    }

    function blockUserFromChat(chatId) {
        const chat = appState.chats.find(c => c.id === chatId);
        if (chat && chat.type === 'private') {
            const otherId = chat.participants.find(p => p !== appState.currentAccount);
            showAlert(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${otherId} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω (—ç–º—É–ª—è—Ü–∏—è)`);
        }
    }

    // === –†–ï–ñ–ò–ú –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø ===
    function toggleEditMode() {
        appState.editMode = !appState.editMode;
        document.getElementById('edit-bar').style.display = appState.editMode ? 'flex' : 'none';
        document.getElementById('edit-btn').innerText = appState.editMode ? t('done') : t('edit');
        if (!appState.editMode) appState.selectedChats = [];
        renderChats();
    }
    function doneEditMode() { toggleEditMode(); }
    function toggleSelectChat(chatId, event) {
        event.stopPropagation();
        const idx = appState.selectedChats.indexOf(chatId);
        if (idx === -1) appState.selectedChats.push(chatId);
        else appState.selectedChats.splice(idx, 1);
        document.getElementById('edit-counter').innerHTML = `${appState.selectedChats.length} ${t('selected')}`;
        renderChats();
    }
    function deleteSelectedChats() {
        if (appState.selectedChats.length === 0) return;
        showConfirm('–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —á–∞—Ç—ã?', (ok) => {
            if (ok) {
                appState.chats = appState.chats.filter(c => !appState.selectedChats.includes(c.id));
                appState.selectedChats.forEach(id => delete appState.messages[id]);
                appState.selectedChats = [];
                toggleEditMode();
                saveState();
                renderChats();
            }
        });
    }
    function pinSelectedChats() {
        appState.chats.forEach(c => {
            if (appState.selectedChats.includes(c.id)) c.pinned = !c.pinned;
        });
        appState.selectedChats = [];
        toggleEditMode();
        saveState();
        renderChats();
    }
    function addToFolder() {
        const folderNames = appState.folders.map(f => f.name).join(', ');
        if (folderNames) {
            showPrompt(`–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏ (–¥–æ—Å—Ç—É–ø–Ω—ã: ${folderNames})`, '', (folderName) => {
                const folder = appState.folders.find(f => f.name === folderName);
                if (folder) {
                    folder.chats = folder.chats || [];
                    appState.selectedChats.forEach(id => {
                        if (!folder.chats.includes(id)) folder.chats.push(id);
                    });
                    saveState();
                }
            });
        } else {
            showAlert('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –ø–∞–ø–∫—É');
        }
    }

    // === –ö–û–ù–¢–ê–ö–¢–´ ===
    function renderContacts() {
        const list = document.getElementById('contacts-list');
        list.innerHTML = '';
        const filter = document.getElementById('global-search').value.toLowerCase();
        appState.users.filter(u => u.id !== appState.currentAccount && (u.name.toLowerCase().includes(filter) || u.username.toLowerCase().includes(filter))).forEach(user => {
            const item = document.createElement('div');
            item.className = 'contact-item';
            item.onclick = () => openPrivateChat(user.id);
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'chat-avatar';
            avatarDiv.innerHTML = user.avatar.startsWith('<img') ? user.avatar : `<span>${user.avatar}</span>`;
            const infoDiv = document.createElement('div');
            infoDiv.className = 'chat-info';
            infoDiv.innerHTML = `
                <div class="chat-name">${user.name} ${appState.localNames[user.id] ? `(${appState.localNames[user.id]})` : ''}</div>
                <div class="chat-last-msg">@${user.username} ¬∑ ${user.online ? '–æ–Ω–ª–∞–π–Ω' : '–±—ã–ª(–∞) ' + formatLastSeen(user.lastSeen)}</div>
            `;
            item.appendChild(avatarDiv);
            item.appendChild(infoDiv);
            list.appendChild(item);
        });
    }

    function formatLastSeen(ts) {
        const diff = Date.now() - ts;
        if (diff < 60000) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
        if (diff < 3600000) return Math.floor(diff / 60000) + ' –º–∏–Ω. –Ω–∞–∑–∞–¥';
        if (diff < 86400000) return Math.floor(diff / 3600000) + ' —á. –Ω–∞–∑–∞–¥';
        return new Date(ts).toLocaleDateString();
    }

    // === –ß–ê–¢ ===
    function openChat(chatId) {
        appState.currentChatId = chatId;
        const chat = appState.chats.find(c => c.id === chatId);
        if (!chat) return;

        appState.recentChats = [chatId, ...appState.recentChats.filter(id => id !== chatId)].slice(0, 5);
        updateRecentChats();

        if (appState.desktopMode && !appState.isMobile) {
            document.getElementById('chat-panel').style.display = 'flex';
            document.getElementById('pc-chat-header-name').innerText = chat.name;
            document.getElementById('pc-chat-header-status').innerText = '–æ–Ω–ª–∞–π–Ω';
            renderMessagesPC(chatId);
        } else {
            document.getElementById('chat-header-name').innerText = chat.name;
            document.getElementById('chat-header-status').innerText = '–æ–Ω–ª–∞–π–Ω';
            renderMessages(chatId);
            showScreen('chat-window');
        }
    }

    function closeChat() {
        appState.currentChatId = null;
        if (appState.desktopMode && !appState.isMobile) {
            document.getElementById('chat-panel').style.display = 'none';
        } else {
            goBack();
        }
        renderChats();
    }

    function renderMessages(chatId) {
        const area = document.getElementById('messages-area');
        area.innerHTML = '';
        const msgs = appState.messages[chatId] || [];
        const chat = appState.chats.find(c => c.id === chatId);
        msgs.sort((a,b) => a.time - b.time);
        msgs.forEach(msg => {
            const isOwn = msg.senderId === appState.currentAccount;
            const sender = isOwn ? appState.me : appState.users.find(u => u.id === msg.senderId) || { name: 'Bot', avatar: 'ü§ñ' };

            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${isOwn ? 'own' : 'other'}`;
            msgDiv.dataset.id = msg.id;
            msgDiv.oncontextmenu = (e) => showMessageContext(e, msg.id);

            let headerHtml = '';
            if (!isOwn && (chat.type === 'group' || chat.type === 'channel')) {
                headerHtml = `
                    <div class="message-header" onclick="showUserProfile('${msg.senderId}')">
                        <div class="message-sender-avatar">${sender.avatar}</div>
                        <span class="message-sender-name">${sender.name}</span>
                    </div>
                `;
            }

            let contentHtml = '';
            if (msg.type === 'file') {
                contentHtml = `<div class="file-message"><span class="file-icon">üìé</span><span>${msg.fileName}</span></div>`;
            } else if (msg.type === 'photo') {
                contentHtml = `<img src="${msg.content}" class="media-preview" onclick="previewMedia('${msg.content}')">`;
            } else if (msg.type === 'video') {
                contentHtml = `<video src="${msg.content}" controls style="max-width:200px; border-radius:12px;"></video>`;
            } else if (msg.type === 'voice') {
                contentHtml = `<div class="voice-message"><div class="voice-circle" onclick="playVoice('${msg.id}')">üé§</div><span>–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</span></div>`;
            } else if (msg.type === 'poll') {
                contentHtml = renderPoll(msg);
            } else {
                contentHtml = `<div>${escapeHtml(msg.content)}</div>`;
            }

            let reactionsHtml = '';
            if (msg.reactions && msg.reactions.length) {
                reactionsHtml = '<div class="message-reactions">' + msg.reactions.map(r => `<span class="reaction">${r}</span>`).join('') + '</div>';
            }

            msgDiv.innerHTML = `
                ${headerHtml}
                <div class="message-bubble">${contentHtml}</div>
                <div class="message-time">${formatTime(msg.time)}</div>
                ${reactionsHtml}
            `;
            area.appendChild(msgDiv);
        });
        scrollToBottom(false);
    }

    function renderMessagesPC(chatId) {
        const area = document.getElementById('pc-messages-area');
        area.innerHTML = '';
        const msgs = appState.messages[chatId] || [];
        const chat = appState.chats.find(c => c.id === chatId);
        msgs.sort((a,b) => a.time - b.time);
        msgs.forEach(msg => {
            const isOwn = msg.senderId === appState.currentAccount;
            const sender = isOwn ? appState.me : appState.users.find(u => u.id === msg.senderId) || { name: 'Bot', avatar: 'ü§ñ' };

            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${isOwn ? 'own' : 'other'}`;
            msgDiv.dataset.id = msg.id;
            msgDiv.oncontextmenu = (e) => showMessageContext(e, msg.id);

            let headerHtml = '';
            if (!isOwn && (chat.type === 'group' || chat.type === 'channel')) {
                headerHtml = `
                    <div class="message-header" onclick="showUserProfile('${msg.senderId}')">
                        <div class="message-sender-avatar">${sender.avatar}</div>
                        <span class="message-sender-name">${sender.name}</span>
                    </div>
                `;
            }

            let contentHtml = '';
            if (msg.type === 'file') {
                contentHtml = `<div class="file-message"><span class="file-icon">üìé</span><span>${msg.fileName}</span></div>`;
            } else if (msg.type === 'photo') {
                contentHtml = `<img src="${msg.content}" class="media-preview" onclick="previewMedia('${msg.content}')">`;
            } else if (msg.type === 'video') {
                contentHtml = `<video src="${msg.content}" controls style="max-width:200px; border-radius:12px;"></video>`;
            } else if (msg.type === 'voice') {
                contentHtml = `<div class="voice-message"><div class="voice-circle" onclick="playVoice('${msg.id}')">üé§</div><span>–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</span></div>`;
            } else if (msg.type === 'poll') {
                contentHtml = renderPoll(msg);
            } else {
                contentHtml = `<div>${escapeHtml(msg.content)}</div>`;
            }

            let reactionsHtml = '';
            if (msg.reactions && msg.reactions.length) {
                reactionsHtml = '<div class="message-reactions">' + msg.reactions.map(r => `<span class="reaction">${r}</span>`).join('') + '</div>';
            }

            msgDiv.innerHTML = `
                ${headerHtml}
                <div class="message-bubble">${contentHtml}</div>
                <div class="message-time">${formatTime(msg.time)}</div>
                ${reactionsHtml}
            `;
            area.appendChild(msgDiv);
        });
        scrollToBottom(true);
    }

    function renderPoll(msg) {
        let html = `<div><strong>${msg.pollQuestion}</strong><br>`;
        msg.pollOptions.forEach((opt, i) => {
            html += `<label><input type="${msg.pollMultiple ? 'checkbox' : 'radio'}" name="poll-${msg.id}" value="${i}"> ${opt}</label><br>`;
        });
        html += `<button onclick="votePoll('${msg.id}')">–ì–æ–ª–æ—Å–æ–≤–∞—Ç—å</button></div>`;
        return html;
    }

    function votePoll(msgId) {
        showAlert('–ì–æ–ª–æ—Å –ø—Ä–∏–Ω—è—Ç (—ç–º—É–ª—è—Ü–∏—è)');
    }

    function scrollToBottom(isPC) {
        const area = isPC ? document.getElementById('pc-messages-area') : document.getElementById('messages-area');
        area.scrollTop = area.scrollHeight;
    }

    function sendMessage(isPC) {
        const inputId = isPC ? 'pc-message-input' : 'message-input';
        const input = document.getElementById(inputId);
        const content = input.value.trim();
        if (!content || !appState.currentChatId) return;

        const newMsg = {
            id: Date.now().toString(),
            senderId: appState.currentAccount,
            content,
            time: Date.now(),
            type: 'text',
            reactions: []
        };
        if (!appState.messages[appState.currentChatId]) appState.messages[appState.currentChatId] = [];
        appState.messages[appState.currentChatId].push(newMsg);
        if (isPC) renderMessagesPC(appState.currentChatId); else renderMessages(appState.currentChatId);
        input.value = '';
        document.getElementById(isPC ? 'pc-send-btn' : 'send-btn').className = 'voice-btn';
        document.getElementById(isPC ? 'pc-send-btn' : 'send-btn').innerText = 'üé§';

        setTimeout(() => {
            const chat = appState.chats.find(c => c.id === appState.currentChatId);
            if (chat.type === 'private') {
                const otherId = chat.participants.find(p => p !== appState.currentAccount);
                if (otherId === 'bot') {
                    const reply = {
                        id: (Date.now() + 1).toString(),
                        senderId: 'bot',
                        content: generateBotReply(content),
                        time: Date.now(),
                        type: 'text',
                        reactions: []
                    };
                    appState.messages[appState.currentChatId].push(reply);
                    if (isPC) renderMessagesPC(appState.currentChatId); else renderMessages(appState.currentChatId);
                    chat.lastMessage = reply.content;
                    chat.lastTime = Date.now();
                }
            }
            saveState();
        }, 1000);
        saveState();
    }

    function generateBotReply(text) {
        const lower = text.toLowerCase();
        if (lower.includes('–ø—Ä–∏–≤–µ—Ç')) return '–ò —Ç–µ–±–µ –ø—Ä–∏–≤–µ—Ç! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?';
        if (lower.includes('–∫–∞–∫ –¥–µ–ª–∞')) return '–£ –º–µ–Ω—è –≤—Å—ë –æ—Ç–ª–∏—á–Ω–æ! –ê —É —Ç–µ–±—è?';
        if (lower.includes('–±–æ—Ç')) return '–î–∞, —è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –±–æ—Ç. –ú–æ–≥—É –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã.';
        if (lower.includes('—Å–ø–∞—Å–∏–±–æ')) return '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞! üòä';
        if (lower.includes('–æ–ø—Ä–æ—Å')) return '–°–æ–∑–¥–∞–π—Ç–µ –æ–ø—Ä–æ—Å —á–µ—Ä–µ–∑ –º–µ–Ω—é —Å–∫—Ä–µ–ø–∫–∏.';
        return '–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ... –†–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ!';
    }

    function handleTyping(isPC) {
        const inputId = isPC ? 'pc-message-input' : 'message-input';
        const input = document.getElementById(inputId);
        const btnId = isPC ? 'pc-send-btn' : 'send-btn';
        const btn = document.getElementById(btnId);
        if (input.value.trim()) {
            btn.className = 'send-btn';
            btn.innerText = '‚û§';
        } else {
            btn.className = 'voice-btn';
            btn.innerText = 'üé§';
        }
    }

    function handleEnterKey(e, isPC) {
        if (e.key === 'Enter') {
            e.preventDefault();
            sendMessage(isPC);
        }
    }

    // === –ú–ï–ù–Æ –ß–ê–¢–ê (—Ç—Ä–∏ —Ç–æ—á–∫–∏) ===
    function toggleChatMenu() {
        const menu = document.getElementById(appState.desktopMode && !appState.isMobile ? 'pc-chat-menu' : 'chat-menu');
        if (menu.style.display === 'block') {
            menu.style.display = 'none';
            return;
        }
        const chat = appState.chats.find(c => c.id === appState.currentChatId);
        if (!chat) return;
        menu.innerHTML = '';
        const items = [
            { label: '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', action: 'openChatInfo' },
            { label: '–í—ã–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è', action: 'muteChat' },
            { label: '–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é', action: 'clearHistory' },
            { label: '–£–¥–∞–ª–∏—Ç—å —á–∞—Ç', action: 'deleteChat' }
        ];
        if (chat.type === 'private') {
            items.push({ label: '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å', action: 'blockUser' });
        } else {
            items.push({ label: '–í—ã–π—Ç–∏ –∏–∑ –≥—Ä—É–ø–ø—ã', action: 'leaveGroup' });
        }
        items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'chat-menu-item';
            div.innerText = item.label;
            div.onclick = () => {
                menu.style.display = 'none';
                if (item.action === 'openChatInfo') openChatInfo();
                else if (item.action === 'muteChat') muteChat(chat.id);
                else if (item.action === 'clearHistory') clearHistory(chat.id);
                else if (item.action === 'deleteChat') deleteChat(chat.id);
                else if (item.action === 'blockUser') blockUserFromChat(chat.id);
                else if (item.action === 'leaveGroup') leaveGroup(chat.id);
            };
            menu.appendChild(div);
        });
        menu.style.display = 'block';
        setTimeout(() => {
            document.addEventListener('click', function hide() {
                menu.style.display = 'none';
                document.removeEventListener('click', hide);
            }, { once: true });
        }, 10);
    }

    function clearHistory(chatId) {
        appState.messages[chatId] = [];
        saveState();
        if (appState.desktopMode && !appState.isMobile) renderMessagesPC(chatId); else renderMessages(chatId);
    }

    function leaveGroup(chatId) {
        const chat = appState.chats.find(c => c.id === chatId);
        if (chat) {
            chat.participants = chat.participants.filter(p => p !== appState.currentAccount);
            saveState();
            closeChat();
        }
    }

    // === –ö–û–ù–¢–ï–ö–°–¢–ù–û–ï –ú–ï–ù–Æ –°–û–û–ë–©–ï–ù–ò–Ø ===
    let currentContextMsgId = null;

    function showMessageContext(e, msgId) {
        e.preventDefault();
        const menu = document.getElementById('message-context-menu');
        menu.style.display = 'block';
        menu.style.left = e.pageX + 'px';
        menu.style.top = e.pageY + 'px';
        currentContextMsgId = msgId;
        setTimeout(() => {
            document.addEventListener('click', function hide() {
                menu.style.display = 'none';
                document.removeEventListener('click', hide);
            }, { once: true });
        }, 10);
    }

    function contextReply() { showAlert('–û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ ' + currentContextMsgId); }
    function contextForward() { showAlert('–ü–µ—Ä–µ—Å–ª–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ ' + currentContextMsgId); }
    function contextCopy() {
        const msg = findMessageById(currentContextMsgId);
        if (msg) navigator.clipboard.writeText(msg.content);
    }
    function contextReact(emoji) {
        const msg = findMessageById(currentContextMsgId);
        if (msg) {
            if (!msg.reactions) msg.reactions = [];
            if (!msg.reactions.includes(emoji)) msg.reactions.push(emoji);
            if (appState.desktopMode && !appState.isMobile) renderMessagesPC(appState.currentChatId);
            else renderMessages(appState.currentChatId);
            saveState();
        }
    }
    function contextDelete() {
        if (!appState.currentChatId) return;
        showConfirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?', (ok) => {
            if (ok) {
                const msgs = appState.messages[appState.currentChatId];
                const idx = msgs.findIndex(m => m.id === currentContextMsgId);
                if (idx !== -1) {
                    msgs.splice(idx, 1);
                    if (appState.desktopMode && !appState.isMobile) renderMessagesPC(appState.currentChatId);
                    else renderMessages(appState.currentChatId);
                    saveState();
                }
            }
        });
    }
    function findMessageById(id) {
        if (!appState.currentChatId) return null;
        return appState.messages[appState.currentChatId]?.find(m => m.id === id);
    }

    // === –ú–ï–ù–Æ –°–ö–†–ï–ü–ö–ò ===
    function toggleAttachMenu() {
        const menu = document.getElementById('attach-menu');
        menu.style.display = menu.style.display === 'none' ? 'flex' : 'none';
    }

    function attachPhoto() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (event) => {
                const newMsg = {
                    id: Date.now().toString(),
                    senderId: appState.currentAccount,
                    content: event.target.result,
                    time: Date.now(),
                    type: 'photo',
                    reactions: []
                };
                appState.messages[appState.currentChatId].push(newMsg);
                if (appState.desktopMode && !appState.isMobile) renderMessagesPC(appState.currentChatId);
                else renderMessages(appState.currentChatId);
                saveState();
            };
            reader.readAsDataURL(file);
        };
        input.click();
        toggleAttachMenu();
    }

    function attachVideo() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'video/*';
        input.onchange = (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (event) => {
                const newMsg = {
                    id: Date.now().toString(),
                    senderId: appState.currentAccount,
                    content: event.target.result,
                    time: Date.now(),
                    type: 'video',
                    reactions: []
                };
                appState.messages[appState.currentChatId].push(newMsg);
                if (appState.desktopMode && !appState.isMobile) renderMessagesPC(appState.currentChatId);
                else renderMessages(appState.currentChatId);
                saveState();
            };
            reader.readAsDataURL(file);
        };
        input.click();
        toggleAttachMenu();
    }

    function attachFile() {
        const input = document.createElement('input');
        input.type = 'file';
        input.onchange = (e) => {
            const file = e.target.files[0];
            const newMsg = {
                id: Date.now().toString(),
                senderId: appState.currentAccount,
                content: `üìé ${file.name}`,
                fileName: file.name,
                time: Date.now(),
                type: 'file',
                reactions: []
            };
            appState.messages[appState.currentChatId].push(newMsg);
            if (appState.desktopMode && !appState.isMobile) renderMessagesPC(appState.currentChatId);
            else renderMessages(appState.currentChatId);
            saveState();
        };
        input.click();
        toggleAttachMenu();
    }

    function showPollScreen() {
        appState.pollOptions = ['', ''];
        document.getElementById('poll-question').value = '';
        document.getElementById('poll-opt1').value = '';
        document.getElementById('poll-opt2').value = '';
        document.getElementById('poll-multiple').checked = false;
        document.getElementById('poll-quiz').checked = false;
        showScreen('poll-screen');
        toggleAttachMenu();
    }

    function hidePollScreen() { goBack(); }

    function addPollOption() {
        const container = document.getElementById('poll-options');
        const newInput = document.createElement('input');
        newInput.type = 'text';
        newInput.placeholder = `–í–∞—Ä–∏–∞–Ω—Ç ${container.children.length + 1}`;
        container.appendChild(newInput);
    }

    function createPoll() {
        const question = document.getElementById('poll-question').value.trim();
        if (!question) { showAlert('–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å'); return; }
        const options = [];
        document.querySelectorAll('#poll-options input').forEach(inp => {
            if (inp.value.trim()) options.push(inp.value.trim());
        });
        if (options.length < 2) { showAlert('–î–æ–±–∞–≤—å—Ç–µ –º–∏–Ω–∏–º—É–º 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞'); return; }
        const multiple = document.getElementById('poll-multiple').checked;
        const quiz = document.getElementById('poll-quiz').checked;
        const pollMsg = {
            id: Date.now().toString(),
            senderId: appState.currentAccount,
            pollQuestion: question,
            pollOptions: options,
            pollMultiple: multiple,
            pollQuiz: quiz,
            time: Date.now(),
            type: 'poll',
            reactions: []
        };
        appState.messages[appState.currentChatId].push(pollMsg);
        if (appState.desktopMode && !appState.isMobile) renderMessagesPC(appState.currentChatId);
        else renderMessages(appState.currentChatId);
        saveState();
        hidePollScreen();
    }

    function attachVoice() {
        if (appState.isMobile) {
            showAlert('–ó–∞–ø–∏—Å—å –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (—ç–º—É–ª—è—Ü–∏—è)');
            const newMsg = {
                id: Date.now().toString(),
                senderId: appState.currentAccount,
                content: 'üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ',
                time: Date.now(),
                type: 'voice',
                reactions: []
            };
            appState.messages[appState.currentChatId].push(newMsg);
            if (appState.desktopMode && !appState.isMobile) renderMessagesPC(appState.currentChatId);
            else renderMessages(appState.currentChatId);
            saveState();
        } else {
            showAlert('–ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ');
        }
        toggleAttachMenu();
    }

    function toggleEmojiPicker(isPC) {
        const picker = document.getElementById('emoji-picker');
        if (picker.style.display === 'none') {
            picker.style.display = 'grid';
            if (picker.children.length === 0) {
                const emojis = ['üòä','üòÇ','‚ù§Ô∏è','üëç','üî•','üò¢','üò°','üéâ','üëè','üíØ','ü§î','üôè','üòÅ','üòé','ü§£','ü•∞','üòò','ü§ó','üòê','üò¥','ü§Ø','ü•≥','ü§©','üò±','ü§¨','üëª','üíÄ','üëΩ'];
                emojis.forEach(e => {
                    const span = document.createElement('span');
                    span.className = 'emoji-item';
                    span.innerText = e;
                    span.onclick = () => addEmoji(e, isPC);
                    picker.appendChild(span);
                });
            }
        } else {
            picker.style.display = 'none';
        }
    }

    function addEmoji(emoji, isPC) {
        const inputId = isPC ? 'pc-message-input' : 'message-input';
        const input = document.getElementById(inputId);
        input.value += emoji;
        input.focus();
        handleTyping(isPC);
        document.getElementById('emoji-picker').style.display = 'none';
    }

    // === –ü–†–û–§–ò–õ–¨ ===
    function showUserProfile(userId) {
        appState.currentProfileUserId = userId;
        const user = userId === appState.currentAccount ? appState.me : appState.users.find(u => u.id === userId);
        if (!user) return;

        const content = document.getElementById('profile-content');
        content.innerHTML = `
            <div class="profile-header">
                <div class="profile-avatar">${user.avatar}</div>
                <div class="profile-name">${user.name}</div>
                <div class="profile-username">@${user.username}</div>
                <div class="profile-birthday">${user.birthday ? `–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è: ${user.birthday}` : ''}</div>
            </div>
            <div class="profile-section">
                <div class="profile-section-title">–û–±—â–∏–µ –≥—Ä—É–ø–ø—ã</div>
                <div>${appState.chats.filter(c => c.type === 'group' && c.participants.includes(userId) && c.participants.includes(appState.currentAccount)).map(g => g.name).join(', ') || '–ù–µ—Ç –æ–±—â–∏—Ö –≥—Ä—É–ø–ø'}</div>
            </div>
            <div class="profile-section">
                <div class="profile-section-title">–ú–µ–¥–∏–∞</div>
                <div class="profile-media">${(() => {
                    const media = [];
                    Object.entries(appState.messages).forEach(([chatId, msgs]) => {
                        const chat = appState.chats.find(c => c.id === chatId);
                        if (chat && chat.participants && chat.participants.includes(userId) && chat.participants.includes(appState.currentAccount)) {
                            msgs.filter(m => m.type === 'file' || m.type === 'photo' || m.type === 'video').forEach(m => media.push(m));
                        }
                    });
                    return media.map(m => `<div class="profile-media-item" onclick="previewMedia('${m.content}')">${m.type === 'photo' ? 'üì∑' : m.type === 'video' ? 'üé•' : 'üìé'} ${m.fileName || '–ú–µ–¥–∏–∞'}</div>`).join('') || '–ù–µ—Ç –º–µ–¥–∏–∞';
                })()}</div>
            </div>
        `;
        document.getElementById('profile-title').innerText = '–ü—Ä–æ—Ñ–∏–ª—å';
        document.getElementById('profile-edit-btn').style.display = userId === appState.currentAccount ? 'inline-block' : 'none';
        showScreen('profile-screen');
    }

    function hideProfile() {
        appState.currentProfileUserId = null;
        goBack();
    }

    function showGroupProfile(chatId) {
        const chat = appState.chats.find(c => c.id === chatId);
        if (!chat) return;
        appState.currentProfileChatId = chatId;
        const content = document.getElementById('profile-content');
        content.innerHTML = `
            <div class="profile-header">
                <div class="profile-avatar">${chat.avatar}</div>
                <div class="profile-name">${chat.name}</div>
                <div class="profile-username">@${chat.id}</div>
                <div class="profile-birthday">${chat.description || ''}</div>
            </div>
            <div class="profile-section">
                <div class="profile-section-title">–£—á–∞—Å—Ç–Ω–∏–∫–∏ (${chat.participants.length})</div>
                <div>${chat.participants.filter(p => p !== appState.currentAccount).map(p => appState.users.find(u => u.id === p)?.name || p).join(', ')}</div>
            </div>
            <div class="profile-section">
                <div class="profile-section-title">–°—Å—ã–ª–∫–∞</div>
                <div>${chat.link || '–Ω–µ—Ç'}</div>
            </div>
            <div class="profile-section">
                <div class="profile-section-title">–ú–µ–¥–∏–∞</div>
                <div class="profile-media">${(() => {
                    const media = [];
                    (appState.messages[chatId] || []).filter(m => m.type !== 'text').forEach(m => media.push(m));
                    return media.map(m => `<div class="profile-media-item" onclick="previewMedia('${m.content}')">${m.type === 'photo' ? 'üì∑' : m.type === 'video' ? 'üé•' : 'üìé'} ${m.fileName || '–ú–µ–¥–∏–∞'}</div>`).join('') || '–ù–µ—Ç –º–µ–¥–∏–∞';
                })()}</div>
            </div>
        `;
        document.getElementById('profile-title').innerText = chat.type === 'group' ? '–ì—Ä—É–ø–ø–∞' : '–ö–∞–Ω–∞–ª';
        document.getElementById('profile-edit-btn').style.display = (chat.owner === appState.currentAccount || chat.admins?.includes(appState.currentAccount)) ? 'inline-block' : 'none';
        showScreen('profile-screen');
    }

    function editProfile() {
        if (appState.currentProfileUserId === appState.currentAccount) {
            const content = document.getElementById('profile-edit-content');
            content.innerHTML = `
                <div style="text-align:center; margin-bottom:24px;">
                    <div class="profile-avatar" id="edit-profile-avatar" onclick="changeProfileAvatar()">${appState.me.avatar}</div>
                    <button onclick="changeProfileAvatarEmoji()">–í—ã–±—Ä–∞—Ç—å —ç–º–æ–¥–∑–∏</button>
                    <button onclick="uploadProfileAvatar()">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</button>
                </div>
                <input type="text" id="edit-profile-name" value="${appState.me.name}" placeholder="–ò–º—è" style="width:100%; padding:12px; background:var(--surface-color); border:1px solid var(--border-color); border-radius:12px; color:var(--text-primary); margin-bottom:16px;">
                <input type="text" id="edit-profile-username" value="${appState.me.username}" readonly placeholder="–Æ–∑–µ—Ä–Ω–µ–π–º" style="width:100%; padding:12px; background:var(--surface-color); border:1px solid var(--border-color); border-radius:12px; color:var(--text-primary); margin-bottom:16px;">
                <input type="date" id="edit-profile-birthday" value="${appState.me.birthday}" style="width:100%; padding:12px; background:var(--surface-color); border:1px solid var(--border-color); border-radius:12px; color:var(--text-primary); margin-bottom:16px;">
            `;
            showScreen('profile-edit-screen');
        } else if (appState.currentProfileChatId) {
            const chat = appState.chats.find(c => c.id === appState.currentProfileChatId);
            if (!chat) return;
            const content = document.getElementById('profile-edit-content');
            content.innerHTML = `
                <div style="text-align:center; margin-bottom:24px;">
                    <div class="profile-avatar" id="edit-chat-avatar" onclick="changeChatAvatar()">${chat.avatar}</div>
                    <button onclick="changeChatAvatarEmoji()">–í—ã–±—Ä–∞—Ç—å —ç–º–æ–¥–∑–∏</button>
                    <button onclick="uploadChatAvatar()">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</button>
                </div>
                <input type="text" id="edit-chat-name" value="${chat.name}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" style="width:100%; padding:12px; background:var(--surface-color); border:1px solid var(--border-color); border-radius:12px; color:var(--text-primary); margin-bottom:16px;">
                <textarea id="edit-chat-description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" style="width:100%; padding:12px; background:var(--surface-color); border:1px solid var(--border-color); border-radius:12px; color:var(--text-primary); margin-bottom:16px;">${chat.description || ''}</textarea>
                <div style="display:flex; gap:12px; margin-bottom:16px;">
                    <div class="privacy-btn" style="flex:1; padding:10px; background:var(--surface-color); border:1px solid var(--border-color); border-radius:12px; text-align:center; cursor:pointer;" onclick="editChatPrivacy('public')">–ü—É–±–ª–∏—á–Ω—ã–π</div>
                    <div class="privacy-btn" style="flex:1; padding:10px; background:var(--surface-color); border:1px solid var(--border-color); border-radius:12px; text-align:center; cursor:pointer;" onclick="editChatPrivacy('private')">–ü—Ä–∏–≤–∞—Ç–Ω—ã–π</div>
                </div>
                <div id="edit-chat-link-container" style="margin-bottom:16px;">
                    <label>–°—Å—ã–ª–∫–∞</label>
                    <input type="text" id="edit-chat-link" value="${chat.link || ''}" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É" style="width:100%; padding:12px; background:var(--surface-color); border:1px solid var(--border-color); border-radius:12px; color:var(--text-primary);">
                </div>
                <h3>–†–∞–∑—Ä–µ—à–µ–Ω–∏—è</h3>
                <label><input type="checkbox" id="edit-perm-send-msg" ${chat.permissions?.sendMsg ? 'checked' : ''}> –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π</label><br>
                <label><input type="checkbox" id="edit-perm-send-media" ${chat.permissions?.sendMedia ? 'checked' : ''}> –û—Ç–ø—Ä–∞–≤–∫–∞ –º–µ–¥–∏–∞</label><br>
                <label><input type="checkbox" id="edit-perm-add-members" ${chat.permissions?.addMembers ? 'checked' : ''}> –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</label><br>
                <label><input type="checkbox" id="edit-perm-pin" ${chat.permissions?.pin ? 'checked' : ''}> –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π</label><br>
                <h3>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã</h3>
                <select id="edit-admins" multiple size="3">
                    ${chat.participants.filter(p => p !== appState.currentAccount).map(p => `<option value="${p}" ${chat.admins?.includes(p) ? 'selected' : ''}>${appState.users.find(u => u.id === p)?.name || p}</option>`).join('')}
                </select><br>
                <h3>–ß—ë—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫</h3>
                <div id="banned-list"></div>
                <button onclick="banUser()">–ó–∞–±–∞–Ω–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</button>
                <button onclick="unbanUser()">–†–∞–∑–±–∞–Ω–∏—Ç—å</button>
                <hr>
                <button onclick="deleteGroup()" style="color:red;">–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É</button>
            `;
            showScreen('profile-edit-screen');
        }
    }

    function hideProfileEdit() { goBack(); }

    function saveProfileEdit() {
        if (appState.currentProfileUserId === appState.currentAccount) {
            appState.me.name = document.getElementById('edit-profile-name').value;
            appState.me.birthday = document.getElementById('edit-profile-birthday').value;
            saveState();
            hideProfileEdit();
            showUserProfile(appState.currentAccount);
        } else if (appState.currentProfileChatId) {
            const chat = appState.chats.find(c => c.id === appState.currentProfileChatId);
            if (!chat) return;
            chat.name = document.getElementById('edit-chat-name').value;
            chat.description = document.getElementById('edit-chat-description').value;
            chat.link = document.getElementById('edit-chat-link').value;
            chat.permissions = {
                sendMsg: document.getElementById('edit-perm-send-msg').checked,
                sendMedia: document.getElementById('edit-perm-send-media').checked,
                addMembers: document.getElementById('edit-perm-add-members').checked,
                pin: document.getElementById('edit-perm-pin').checked
            };
            const select = document.getElementById('edit-admins');
            chat.admins = Array.from(select.selectedOptions).map(opt => opt.value);
            saveState();
            hideProfileEdit();
            showGroupProfile(appState.currentProfileChatId);
        }
    }

    // === –°–û–ó–î–ê–ù–ò–ï –ì–†–£–ü–ü–´/–ö–ê–ù–ê–õ–ê ===
    function showCreateGroupType() { showScreen('create-group-type-screen'); }
    function hideCreateGroupType() { goBack(); }

    function startCreateGroup(type) {
        appState.groupType = type;
        appState.createStep = 1;
        appState.selectedParticipants = [];
        renderCreateMembersList();
        showScreen('create-group-members-screen');
    }

    function renderCreateMembersList() {
        const list = document.getElementById('create-group-members-list');
        list.innerHTML = '';
        appState.users.filter(u => u.id !== appState.currentAccount).forEach(user => {
            const div = document.createElement('div');
            div.className = 'participant-item';
            div.innerHTML = `
                <div class="chat-avatar">${user.avatar}</div>
                <div class="chat-info">
                    <div class="chat-name">${user.name}</div>
                    <div class="chat-username">@${user.username}</div>
                </div>
                <input type="checkbox" id="create-user-${user.id}" value="${user.id}" style="width:20px; height:20px;">
            `;
            list.appendChild(div);
        });
    }

    function hideCreateGroupMembers() { goBack(); }

    function nextCreateGroupStep() {
        const checkboxes = document.querySelectorAll('#create-group-members-list input:checked');
        appState.selectedParticipants = Array.from(checkboxes).map(cb => cb.value);
        if (appState.groupType === 'group' && appState.selectedParticipants.length === 0) {
            showAlert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞');
            return;
        }
        appState.createStep = 2;
        document.getElementById('create-group-title').innerText = appState.groupType === 'group' ? '–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É' : '–°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª';
        document.getElementById('create-group-name').value = '';
        document.getElementById('create-group-description').value = '';
        document.getElementById('create-group-avatar').innerHTML = 'üì∑';
        document.getElementById('create-group-link-container').style.display = 'none';
        document.getElementById('group-permissions').style.display = appState.groupType === 'group' ? 'block' : 'none';
        showScreen('create-group-detail-screen');
    }

    function prevCreateGroupStep() {
        appState.createStep = 1;
        showScreen('create-group-members-screen');
    }

    function hideCreateGroupDetail() { goBack(); }

    function chooseGroupAvatar() {
        showPrompt('–í–≤–µ–¥–∏—Ç–µ —ç–º–æ–¥–∑–∏ –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞', appState.groupAvatar, (emoji) => {
            if (emoji) {
                appState.groupAvatar = emoji;
                document.getElementById('create-group-avatar').innerHTML = `<span>${emoji}</span>`;
            }
        });
    }

    function chooseGroupAvatarEmoji() { chooseGroupAvatar(); }
    function uploadGroupAvatar() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (event) => {
                appState.groupAvatar = `<img src="${event.target.result}" style="width:100%; height:100%; border-radius:50%;">`;
                document.getElementById('create-group-avatar').innerHTML = `<img src="${event.target.result}" style="width:100%; height:100%; border-radius:50%;">`;
            };
            reader.readAsDataURL(file);
        };
        input.click();
    }

    function selectCreatePrivacy(privacy) {
        appState.groupPrivacy = privacy;
        document.querySelectorAll('.privacy-btn').forEach(btn => btn.classList.remove('active'));
        if (privacy === 'public') {
            document.querySelectorAll('.privacy-btn')[0].classList.add('active');
            document.getElementById('create-group-link-container').style.display = 'none';
        } else {
            document.querySelectorAll('.privacy-btn')[1].classList.add('active');
            appState.groupLink = 'https://t.me/joinchat/' + Math.random().toString(36).substring(2, 10);
            document.getElementById('create-group-link').value = appState.groupLink;
            document.getElementById('create-group-link-container').style.display = 'block';
        }
    }

    function copyGroupLink() {
        navigator.clipboard.writeText(appState.groupLink).then(() => {
            showAlert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞');
        });
    }

    function createGroupFinal() {
        const name = document.getElementById('create-group-name').value.trim();
        if (!name) { showAlert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ'); return; }
        const description = document.getElementById('create-group-description').value.trim();
        const newId = appState.groupType + Date.now();
        const newChat = {
            id: newId,
            type: appState.groupType,
            name: name,
            avatar: appState.groupAvatar,
            participants: [appState.currentAccount, ...(appState.groupType === 'group' ? appState.selectedParticipants : [])],
            lastMessage: appState.groupType === 'group' ? '–ì—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞' : '–ö–∞–Ω–∞–ª —Å–æ–∑–¥–∞–Ω',
            lastTime: Date.now(),
            unread: 0,
            pinned: false,
            description: description,
            privacy: appState.groupPrivacy,
            public: appState.groupPrivacy === 'public',
            link: appState.groupPrivacy === 'private' ? appState.groupLink : null,
            owner: appState.currentAccount,
            admins: [appState.currentAccount],
            permissions: appState.groupType === 'group' ? {
                sendMsg: document.getElementById('perm-send-msg').checked,
                sendMedia: document.getElementById('perm-send-media').checked,
                addMembers: document.getElementById('perm-add-members').checked,
                pin: document.getElementById('perm-pin').checked
            } : null,
            banned: []
        };
        appState.chats.push(newChat);
        appState.messages[newId] = [{ id: 'sys1', senderId: 'system', content: `${appState.groupType === 'group' ? '–ì—Ä—É–ø–ø–∞' : '–ö–∞–Ω–∞–ª'} —Å–æ–∑–¥–∞–Ω`, time: Date.now(), type: 'text', reactions: [] }];
        saveState();
        hideCreateGroupDetail();
        hideCreateGroupType();
        renderChats();
        renderFoldersRow();
        goBack();
    }

    // === –ù–ê–°–¢–†–û–ô–ö–ò ===
    function showThemes() { showScreen('themes-screen'); }
    function hideThemes() { goBack(); }
    function selectTheme(theme) {
        appState.theme = theme;
        applyThemeAndWallpaper();
        saveState();
        hideThemes();
    }
    function selectWallpaper(wallpaper) {
        appState.wallpaper = wallpaper;
        applyThemeAndWallpaper();
        saveState();
        hideThemes();
    }
    function setDesktopMode(enable) {
        appState.desktopMode = enable;
        localStorage.setItem('desktopMode', enable);
        document.body.classList.toggle('pc-mode', enable && !appState.isMobile);
        document.body.classList.toggle('mobile-mode', !enable || appState.isMobile);
        hideThemes();
    }

    function showPrivacy() { updatePrivacyDisplay(); showScreen('privacy-screen'); }
    function hidePrivacy() { goBack(); }
    function cyclePrivacy(key) {
        const order = ['everyone', 'contacts', 'nobody'];
        let current = appState.privacy[key];
        let idx = order.indexOf(current);
        idx = (idx + 1) % order.length;
        appState.privacy[key] = order[idx];
        updatePrivacyDisplay();
        saveState();
    }
    function updatePrivacyDisplay() {
        const map = { everyone: '–í—Å–µ', contacts: '–ú–æ–∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã', nobody: '–ù–∏–∫—Ç–æ' };
        document.getElementById('privacy-phone').innerText = map[appState.privacy.phone];
        document.getElementById('privacy-lastSeen').innerText = map[appState.privacy.lastSeen];
        document.getElementById('privacy-photo').innerText = map[appState.privacy.photo];
        document.getElementById('privacy-status').innerText = map[appState.privacy.status];
        document.getElementById('privacy-groups').innerText = map[appState.privacy.groups];
        document.getElementById('privacy-calls').innerText = map[appState.privacy.calls];
    }

    function showDevices() {
        const list = document.getElementById('devices-list');
        list.innerHTML = '';
        const ua = navigator.userAgent;
        let os = 'Unknown';
        if (ua.includes('Win')) os = 'Windows';
        else if (ua.includes('Mac')) os = 'MacOS';
        else if (ua.includes('Linux')) os = 'Linux';
        else if (ua.includes('Android')) os = 'Android';
        else if (ua.includes('iPhone') || ua.includes('iPad')) os = 'iOS';
        const devices = [
            { name: '–≠—Ç–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ', detail: `${os} ¬∑ ${navigator.platform}`, active: true },
            { name: '–î—Ä—É–≥–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ (—Å–∏–º—É–ª—è—Ü–∏—è)', detail: '–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥ 2 –¥–Ω—è –Ω–∞–∑–∞–¥', active: false }
        ];
        devices.forEach(d => {
            const div = document.createElement('div');
            div.className = 'device-item';
            div.innerHTML = `<div class="device-icon">${d.active ? 'üü¢' : '‚ö™'}</div><div class="device-info"><div class="device-name">${d.name}</div><div class="device-detail">${d.detail}</div></div>`;
            list.appendChild(div);
        });
        showScreen('devices-screen');
    }
    function hideDevices() { goBack(); }
    function terminateOtherSessions() {
        showConfirm('–ó–∞–≤–µ—Ä—à–∏—Ç—å –≤—Å–µ –¥—Ä—É–≥–∏–µ —Å–µ–∞–Ω—Å—ã?', (ok) => {
            if (ok) showAlert('–î—Ä—É–≥–∏–µ —Å–µ–∞–Ω—Å—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã (—ç–º—É–ª—è—Ü–∏—è)');
        });
    }

    function showFolders() { renderFolders(); showScreen('folders-screen'); }
    function hideFolders() { goBack(); }

    function renderFolders() {
        const list = document.getElementById('folders-list');
        list.innerHTML = '';
        appState.folders.forEach(folder => {
            const div = document.createElement('div');
            div.className = 'folder-item';
            div.onclick = () => openFolder(folder.id);
            div.innerHTML = `<div class="folder-color ${folder.color}"></div><div class="folder-name">${folder.name}</div><div class="folder-count">${folder.chats?.length || 0}</div>`;
            list.appendChild(div);
        });
    }

    function showCreateFolder() {
        appState.folderColor = 'black';
        document.getElementById('folder-name').value = '';
        renderFolderChatSelect();
        showScreen('create-folder-screen');
    }
    function hideCreateFolder() { goBack(); }
    function selectFolderColor(color) {
        appState.folderColor = color;
        document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
        document.querySelector(`.color-option.${color}`).classList.add('selected');
    }
    function renderFolderChatSelect() {
        const list = document.getElementById('folder-chat-select');
        list.innerHTML = '';
        appState.chats.forEach(chat => {
            const div = document.createElement('div');
            div.className = 'participant-item';
            div.innerHTML = `<input type="checkbox" id="folder-chat-${chat.id}" value="${chat.id}"><label for="folder-chat-${chat.id}">${chat.name}</label>`;
            list.appendChild(div);
        });
    }
    function createFolderFinal() {
        const name = document.getElementById('folder-name').value.trim();
        if (!name) { showAlert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏'); return; }
        const checkboxes = document.querySelectorAll('#folder-chat-select input:checked');
        const selectedChats = Array.from(checkboxes).map(cb => cb.value);
        const newFolder = { id: 'folder' + Date.now(), name, color: appState.folderColor, chats: selectedChats };
        appState.folders.push(newFolder);
        saveState();
        hideCreateFolder();
        showFolders();
        renderFoldersRow();
    }
    function openFolder(folderId) {
        appState.currentFolderId = folderId;
        const folder = appState.folders.find(f => f.id === folderId);
        document.getElementById('folder-detail-title').innerText = folder.name;
        const chatsList = document.getElementById('folder-chats-list');
        chatsList.innerHTML = '';
        folder.chats.forEach(chatId => {
            const chat = appState.chats.find(c => c.id === chatId);
            if (chat) {
                const div = document.createElement('div');
                div.className = 'chat-item';
                div.onclick = () => openChat(chat.id);
                div.innerHTML = `<div class="chat-avatar">${chat.avatar}</div><div class="chat-info"><div class="chat-name">${chat.name}</div><div class="chat-last-msg">${chat.lastMessage}</div></div>`;
                chatsList.appendChild(div);
            }
        });
        showScreen('folder-detail-screen');
    }
    function hideFolderDetail() { appState.currentFolderId = null; goBack(); }
    function editFolder() {
        const folder = appState.folders.find(f => f.id === appState.currentFolderId);
        if (!folder) return;
        showPrompt('–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏:', folder.name, (newName) => {
            if (newName) folder.name = newName;
            saveState();
            renderFolders();
            hideFolderDetail();
        });
    }

    function showLanguage() { showScreen('language-screen'); }
    function hideLanguage() { goBack(); }
    function selectLanguage(lang) {
        appState.language = lang;
        document.getElementById('current-lang').innerText = lang === 'ru' ? '–†—É—Å—Å–∫–∏–π' : 'English';
        saveState();
        applyTranslations();
        hideLanguage();
    }

    function showAbout() { 
        document.getElementById('account-count').innerText = appState.accounts.length;
        showScreen('about-screen'); 
    }
    function hideAbout() { goBack(); }

    // === –ë–û–ö–û–í–ê–Ø –ü–ê–ù–ï–õ–¨ ===
    function updateRecentChats() {
        const sidebar = document.getElementById('recent-chats-sidebar');
        if (!appState.desktopMode || appState.isMobile) {
            sidebar.style.display = 'none';
            return;
        }
        sidebar.style.display = 'flex';
        sidebar.innerHTML = '';
        appState.recentChats.forEach(chatId => {
            const chat = appState.chats.find(c => c.id === chatId);
            if (!chat) return;
            const div = document.createElement('div');
            div.className = 'recent-chat-avatar';
            div.onclick = () => openChat(chat.id);
            div.innerHTML = chat.avatar.startsWith('<img') ? chat.avatar : `<span>${chat.avatar}</span>`;
            sidebar.appendChild(div);
        });
        document.body.style.paddingLeft = '80px';
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function previewMedia(src) {
        const modal = document.createElement('div');
        modal.className = 'media-modal';
        modal.onclick = () => modal.remove();
        const img = document.createElement('img');
        img.src = src;
        img.style.maxWidth = '90%';
        img.style.maxHeight = '90%';
        modal.appendChild(img);
        document.body.appendChild(modal);
    }

    function playVoice(id) {
        showAlert('–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è ' + id);
    }

    function openChatInfo() {
        if (!appState.currentChatId) return;
        const chat = appState.chats.find(c => c.id === appState.currentChatId);
        if (chat.type === 'private') {
            const otherId = chat.participants.find(p => p !== appState.currentAccount);
            if (otherId) showUserProfile(otherId);
        } else {
            showGroupProfile(chat.id);
        }
    }

    function changeProfileAvatar() { showAlert('–í—ã–±–æ—Ä –∞–≤–∞—Ç–∞—Ä–∞ (—ç–º—É–ª—è—Ü–∏—è)'); }
    function changeProfileAvatarEmoji() { showAlert('–í—ã–±–æ—Ä —ç–º–æ–¥–∑–∏'); }
    function uploadProfileAvatar() { showAlert('–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ'); }
    function changeChatAvatar() { chooseGroupAvatar(); }
    function changeChatAvatarEmoji() { chooseGroupAvatarEmoji(); }
    function uploadChatAvatar() { uploadGroupAvatar(); }
    function editChatPrivacy(privacy) {
        appState.groupPrivacy = privacy;
        document.querySelectorAll('.privacy-btn').forEach(btn => btn.classList.remove('active'));
        if (privacy === 'public') {
            document.querySelectorAll('.privacy-btn')[0].classList.add('active');
            document.getElementById('edit-chat-link-container').style.display = 'none';
        } else {
            document.querySelectorAll('.privacy-btn')[1].classList.add('active');
            document.getElementById('edit-chat-link-container').style.display = 'block';
        }
    }
    function banUser() { showAlert('–ó–∞–±–∞–Ω–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞ (—ç–º—É–ª—è—Ü–∏—è)'); }
    function unbanUser() { showAlert('–†–∞–∑–±–∞–Ω–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞ (—ç–º—É–ª—è—Ü–∏—è)'); }
    function deleteGroup() { 
        showConfirm('–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É?', (ok) => {
            if (ok) {
                appState.chats = appState.chats.filter(c => c.id !== appState.currentProfileChatId);
                saveState();
                hideProfileEdit();
                goBack();
                renderChats();
            }
        });
    }

    // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
    document.addEventListener('DOMContentLoaded', () => {
        applyThemeAndWallpaper();
        if (appState.accounts.length > 0) {
            showMainScreen();
        } else {
            document.getElementById('auth-screen').classList.add('active');
        }
        renderChats();
        renderContacts();
        window.addEventListener('resize', () => {
            appState.isMobile = window.innerWidth < 768;
            document.body.classList.toggle('pc-mode', appState.desktopMode && !appState.isMobile);
            document.body.classList.toggle('mobile-mode', !appState.desktopMode || appState.isMobile);
            updateRecentChats();
        });
        updateRecentChats();
    });
</script>
</body>
</html>
